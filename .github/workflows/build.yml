name: Build After Effects Plugin

on:
  # プルリクエスト (main/master/developブランチ対象) でトリガー
  pull_request:
    branches: [ main, master, develop ]
  
  # 'v'で始まるタグ (例: v1.0.0) がプッシュされた時にトリガー
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  
  # 手動実行
  workflow_dispatch:

jobs:
  # ============================================
  # ジョブ1: ビルドとテスト (署名なし)
  # プルリクエストの検証用 - Mac/Windows両方
  # ============================================
  build-test:
    name: Build and Test (Unsigned)
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}

    steps:
      # 1. コードのチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. Mac用: Xcodeバージョンの設定
      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # 3. Mac用: Xcodeライセンスの同意
      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      # 4. Windows用: Visual Studio セットアップ
      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      # 5. Mac用: プロジェクトパスの確認
      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      # 5. Windows用: プロジェクトパスの確認
      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # 5.5. プロジェクトパスを統合
      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 6. Mac用: GitHubリリースからAE SDKをダウンロード
      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          set -e  # エラー時に即座に終了
          
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDKが既に存在するか確認
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "✅ AeSDKが既に存在します: $EXPECTED_SDK_PATH"
            exit 0
          fi
          
          # GitHub APIを使用してリリース情報を取得
          # リリースタグの候補（優先順位順）
          RELEASE_TAG_CANDIDATES=("sdk" "ae-sdk_25.6_61" "v25.6.61" "25.6.61")
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "📦 GitHubリリースからAeSDKをダウンロードします"
          echo "   リポジトリ: $REPO"
          echo "   SDKファイル: ${{ matrix.sdk_file }}"
          
          # トークンの確認
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "❌ GITHUB_TOKENが設定されていません"
            echo "   GitHub Secretsに AE_SDK_DOWNLOAD_TOKEN を設定してください"
            exit 1
          fi
          
          # リリース情報を取得（複数のタグ候補を試す）
          RELEASE_JSON=""
          HTTP_STATUS=""
          FOUND_TAG=""
          
          for RELEASE_TAG in "${RELEASE_TAG_CANDIDATES[@]}"; do
            echo "🔍 リリース情報を取得中... (タグ: $RELEASE_TAG)"
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "📊 HTTPステータス: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG="$RELEASE_TAG"
              echo "✅ リリースを見つけました: $FOUND_TAG"
              break
            else
              echo "⚠️  タグ '$RELEASE_TAG' が見つかりませんでした (HTTP $HTTP_STATUS)"
            fi
          done
          
          # どのタグも見つからない場合、最新リリースを試す
          if [ -z "$FOUND_TAG" ]; then
            echo "⚠️  指定されたタグが見つかりません。最新リリースを取得します..."
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/latest" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "✅ 最新リリースを見つけました: $FOUND_TAG"
            fi
          fi
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "❌ リリース情報の取得に失敗しました (HTTP $HTTP_STATUS)"
            echo "レスポンス:"
            echo "$RELEASE_JSON" | head -30
            echo ""
            echo "考えられる原因:"
            echo "  1. リポジトリが存在しない、またはプライベートリポジトリでアクセス権限がない"
            echo "  2. リリースタグが存在しない（試したタグ: ${RELEASE_TAG_CANDIDATES[*]}）"
            echo "  3. GitHub Personal Access Token (PAT) の権限が不足している"
            echo "  4. AE_SDK_DOWNLOAD_TOKEN が正しく設定されていない"
            echo ""
            echo "デバッグ情報:"
            echo "  リポジトリ: $REPO"
            echo "  試したタグ: ${RELEASE_TAG_CANDIDATES[*]}"
            exit 1
          fi
          
          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | grep -q '"message":"Not Found"'; then
            echo "❌ リリースが見つかりません"
            echo "レスポンス:"
            echo "$RELEASE_JSON" | head -30
            exit 1
          fi
          
          # アセットの一覧を表示（デバッグ用）
          echo "📋 利用可能なアセット:"
          echo "$RELEASE_JSON" | jq -r '.assets[]?.name' | head -10 | while read name; do
            [ -n "$name" ] && echo "   - $name"
          done

          # アセットの情報を取得
          ASSET_NAME="${{ matrix.sdk_file }}"
          ASSET_JSON=$(echo "$RELEASE_JSON" | jq -c --arg name "$ASSET_NAME" '.assets[]? | select(.name == $name)' | head -1)

          if [ -z "$ASSET_JSON" ]; then
            echo "❌ SDKファイルが見つかりません: $ASSET_NAME"
            echo "利用可能なアセットの一覧:"
            echo "$RELEASE_JSON" | jq -r '.assets[]?.name' | head -10
            exit 1
          fi

          API_DOWNLOAD_URL=$(echo "$ASSET_JSON" | jq -r '.url // empty')
          BROWSER_DOWNLOAD_URL=$(echo "$ASSET_JSON" | jq -r '.browser_download_url // empty')

          if [ -z "$API_DOWNLOAD_URL" ]; then
            echo "❌ APIダウンロードURLが取得できません"
            echo "$ASSET_JSON"
            exit 1
          fi

          echo "📥 ダウンロードURL(API): $API_DOWNLOAD_URL"
          [ -n "$BROWSER_DOWNLOAD_URL" ] && echo "📥 ダウンロードURL(ブラウザ): $BROWSER_DOWNLOAD_URL"
          
          # SDKをダウンロード（認証ヘッダーを付ける）
          echo "⬇️  SDKをダウンロード中..."
          echo "   ダウンロードURL: ${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}"
          echo "   認証: $([ -n "$GITHUB_TOKEN" ] && echo "あり" || echo "なし")"
          
          # まず認証付きで試す
          CURL_OUTPUT=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -H "User-Agent: GitHub-Actions" \
               -o AE_SDK.zip \
               -s -S "$API_DOWNLOAD_URL" 2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_STATUS=$(echo "$CURL_OUTPUT" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
          
          # エラーメッセージを取得（HTTP_STATUS行を除く）
          CURL_ERROR=$(echo "$CURL_OUTPUT" | grep -v "HTTP_STATUS:" || echo "")
          
          echo "📊 HTTPステータス: $HTTP_STATUS"
          echo "📊 curl終了コード: $CURL_EXIT_CODE"
          
          if [ -n "$CURL_ERROR" ]; then
            echo "📊 curlエラーメッセージ:"
            echo "$CURL_ERROR" | head -10
          fi
          
          # HTTPステータスが200でない場合、またはcurlが失敗した場合
          if [ "$HTTP_STATUS" != "200" ] || [ "$CURL_EXIT_CODE" != "0" ]; then
            echo "⚠️  認証付きダウンロードに失敗しました (HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE)"
            
            # ファイルが存在する場合は削除
            [ -f "AE_SDK.zip" ] && rm -f AE_SDK.zip
            
            # 認証なしで試す（パブリックリポジトリの場合）
            echo "試行: 認証なしでダウンロードを試みます..."
            CURL_OUTPUT2=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
                 -H "Accept: application/octet-stream" \
                 -H "User-Agent: GitHub-Actions" \
                 -o AE_SDK.zip \
                 -s -S "${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}" 2>&1)
            
            CURL_EXIT_CODE2=$?
            HTTP_STATUS2=$(echo "$CURL_OUTPUT2" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
            CURL_ERROR2=$(echo "$CURL_OUTPUT2" | grep -v "HTTP_STATUS:" || echo "")
            
            echo "📊 HTTPステータス (認証なし): $HTTP_STATUS2"
            echo "📊 curl終了コード (認証なし): $CURL_EXIT_CODE2"
            
            if [ -n "$CURL_ERROR2" ]; then
              echo "📊 curlエラーメッセージ (認証なし):"
              echo "$CURL_ERROR2" | head -10
            fi
            
            if [ "$HTTP_STATUS2" != "200" ] || [ "$CURL_EXIT_CODE2" != "0" ]; then
              echo "❌ SDKのダウンロードに失敗しました"
              echo ""
              echo "デバッグ情報:"
              echo "  ダウンロードURL: ${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}"
              echo "  認証付き: HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE"
              echo "  認証なし: HTTP $HTTP_STATUS2, exit $CURL_EXIT_CODE2"
              echo "  トークン設定: $([ -n "$GITHUB_TOKEN" ] && echo "あり (長さ: ${#GITHUB_TOKEN})" || echo "なし")"
              echo ""
              echo "考えられる原因:"
              echo "  1. GitHub Personal Access Token (PAT) の権限が不足している"
              echo "  2. プライベートリポジトリへのアクセス権限がない"
              echo "  3. トークンが期限切れまたは無効"
              echo "  4. ダウンロードURLが無効またはアクセスできない"
              echo "  5. ネットワークエラーまたはタイムアウト"
              exit 1
            else
              echo "✅ 認証なしでダウンロード成功"
            fi
          else
            echo "✅ 認証付きでダウンロード成功"
          fi
          
          # ダウンロードしたファイルの確認
          if [ ! -f "AE_SDK.zip" ] || [ ! -s "AE_SDK.zip" ]; then
            echo "❌ ダウンロードしたファイルが無効です"
            exit 1
          fi
          
          echo "✅ ダウンロード完了 ($(du -h AE_SDK.zip | cut -f1))"
          
          # SDKを展開（テンポラリディレクトリへ）
          echo "📦 SDKを展開中..."
          EXTRACT_DIR=$(mktemp -d)
          if ! unzip -q AE_SDK.zip -d "$EXTRACT_DIR"; then
            echo "❌ SDKの展開に失敗しました"
            ls -la "$EXTRACT_DIR" || true
            exit 1
          fi

          find_sdk_root() {
            find "$EXTRACT_DIR" -type d | while IFS= read -r dir; do
              if [ "$dir" = "$EXTRACT_DIR" ]; then
                continue
              fi
              if [ -d "$dir/Headers" ] && [ -d "$dir/Util" ]; then
                echo "$dir"
                break
              fi
            done
          }

          SDK_ROOT=$(find_sdk_root)

          find_source_dir() {
            local pattern=$1
            find "$EXTRACT_DIR" -type d -path "$pattern" -print -quit
          }

          if [ -n "$SDK_ROOT" ]; then
            HEADERS_SRC="$SDK_ROOT/Headers"
            UTIL_SRC="$SDK_ROOT/Util"
          else
            HEADERS_SRC=$(find_source_dir "*/AfterEffectsSDK*/Headers")
            UTIL_SRC=$(find_source_dir "*/AfterEffectsSDK*/Util")
          fi

          # フォールバック: 最初に見つかったHeaders/Util
          [ -z "$HEADERS_SRC" ] && HEADERS_SRC=$(find "$EXTRACT_DIR" -type d -name "Headers" -print -quit)
          [ -z "$UTIL_SRC" ] && UTIL_SRC=$(find "$EXTRACT_DIR" -type d -name "Util" -print -quit)

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            echo "❌ SDK内に Headers/Util が見つかりません"
            find "$EXTRACT_DIR" -maxdepth 3 -type d | head -40
            exit 1
          fi

          mkdir -p "$EXPECTED_SDK_PATH"
          rm -rf "$EXPECTED_SDK_PATH/Headers" "$EXPECTED_SDK_PATH/Util"
          cp -R "$HEADERS_SRC" "$EXPECTED_SDK_PATH/Headers"
          cp -R "$UTIL_SRC" "$EXPECTED_SDK_PATH/Util"

          # クリーンアップ
          rm -f AE_SDK.zip
          rm -rf "$EXTRACT_DIR"
          
          # 最終確認
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "✅ AeSDKのセットアップが完了しました"
            echo "📁 AeSDKパス: $EXPECTED_SDK_PATH"
            echo "📁 Headers: $EXPECTED_SDK_PATH/Headers ($(ls -1 "$EXPECTED_SDK_PATH/Headers" | wc -l | xargs) ファイル)"
            echo "📁 Util: $EXPECTED_SDK_PATH/Util ($(ls -1 "$EXPECTED_SDK_PATH/Util" | wc -l | xargs) ファイル)"
          else
            echo "❌ AeSDKのセットアップに失敗しました"
            echo "想定パス: $EXPECTED_SDK_PATH"
            echo "存在確認:"
            [ -d "$EXPECTED_SDK_PATH" ] && echo "  - ディレクトリは存在します" || echo "  - ディレクトリが存在しません"
            [ -d "$EXPECTED_SDK_PATH/Headers" ] && echo "  - Headers/ は存在します" || echo "  - Headers/ が存在しません"
            [ -d "$EXPECTED_SDK_PATH/Util" ] && echo "  - Util/ は存在します" || echo "  - Util/ が存在しません"
            echo ""
            echo "展開されたファイル:"
            ls -la "$(dirname "$EXPECTED_SDK_PATH")" | head -20
            exit 1
          fi

      # 6. Windows用: GitHubリリースからAE SDKをダウンロード
      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          
          $EXPECTED_SDK_PATH = "${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDKが既に存在するか確認
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "✅ AeSDKが既に存在します: $EXPECTED_SDK_PATH"
            exit 0
          }
          
          # GitHub APIを使用してリリース情報を取得
          # リリースタグの候補（優先順位順）
          $RELEASE_TAG_CANDIDATES = @("sdk", "ae-sdk_25.6_61", "v25.6.61", "25.6.61")
          $REPO = "rebuildup/my-ae-sdk-storage"
          
          Write-Output "📦 GitHubリリースからAeSDKをダウンロードします"
          Write-Output "   リポジトリ: $REPO"
          Write-Output "   SDKファイル: ${{ matrix.sdk_file }}"
          
          # トークンの確認
          if (-not $env:GITHUB_TOKEN) {
            Write-Output "❌ GITHUB_TOKENが設定されていません"
            Write-Output "   GitHub Secretsに AE_SDK_DOWNLOAD_TOKEN を設定してください"
            exit 1
          }
          
          # リリース情報を取得（複数のタグ候補を試す）
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept = "application/vnd.github.v3+json"
          }
          
          $releaseJson = $null
          $foundTag = $null
          
          foreach ($RELEASE_TAG in $RELEASE_TAG_CANDIDATES) {
            Write-Output "🔍 リリース情報を取得中... (タグ: $RELEASE_TAG)"
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $RELEASE_TAG
              Write-Output "✅ リリースを見つけました: $foundTag"
              break
            } catch {
              $statusCode = $_.Exception.Response.StatusCode.value__
              Write-Output "⚠️  タグ '$RELEASE_TAG' が見つかりませんでした (HTTP $statusCode)"
            }
          }
          
          # どのタグも見つからない場合、最新リリースを試す
          if (-not $releaseJson) {
            Write-Output "⚠️  指定されたタグが見つかりません。最新リリースを取得します..."
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/latest"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $releaseJson.tag_name
              Write-Output "✅ 最新リリースを見つけました: $foundTag"
            } catch {
              Write-Output "❌ リリース情報の取得に失敗しました"
              Write-Output "HTTPステータス: $($_.Exception.Response.StatusCode.value__)"
              Write-Output "エラーメッセージ: $($_.Exception.Message)"
              Write-Output ""
              Write-Output "考えられる原因:"
              Write-Output "  1. リポジトリが存在しない、またはプライベートリポジトリでアクセス権限がない"
              Write-Output "  2. リリースタグが存在しない（試したタグ: $($RELEASE_TAG_CANDIDATES -join ', ')）"
              Write-Output "  3. GitHub Personal Access Token (PAT) の権限が不足している"
              Write-Output "  4. AE_SDK_DOWNLOAD_TOKEN が正しく設定されていない"
              exit 1
            }
          }
          
          # アセットの一覧を表示（デバッグ用）
          Write-Output "📋 利用可能なアセット:"
          $releaseJson.assets | ForEach-Object { Write-Output "   - $($_.name)" }
          
          # アセットのダウンロードURLを取得
          $asset = $releaseJson.assets | Where-Object { $_.name -eq "${{ matrix.sdk_file }}" } | Select-Object -First 1

          if (-not $asset) {
            Write-Output "❌ SDKファイルが見つかりません: ${{ matrix.sdk_file }}"
            Write-Output "利用可能なアセットの一覧:"
            $releaseJson.assets | ForEach-Object { Write-Output "   - $($_.name)" }
            exit 1
          }

          $apiDownloadUrl = $asset.url
          $browserDownloadUrl = $asset.browser_download_url

          if (-not $apiDownloadUrl) {
            Write-Output "❌ APIダウンロードURLが取得できません"
            Write-Output ($asset | ConvertTo-Json -Depth 5)
            exit 1
          }

          Write-Output "📥 ダウンロードURL(API): $apiDownloadUrl"
          if ($browserDownloadUrl) { Write-Output "📥 ダウンロードURL(ブラウザ): $browserDownloadUrl" }

          # SDKをダウンロード (API経由)
          Write-Output "⬇️  SDKをダウンロード中..."
          $outputPath = "AE_SDK.zip"
          $downloadHeaders = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept = "application/octet-stream"
            "User-Agent" = "GitHub-Actions"
          }

          try {
            Invoke-WebRequest -Uri $apiDownloadUrl -Headers $downloadHeaders -OutFile $outputPath -ErrorAction Stop
          } catch {
            Write-Output "⚠️  API経由のダウンロードに失敗しました: $($_.Exception.Message)"
            if ($browserDownloadUrl) {
              Write-Output "試行: ブラウザURLを使用 (認証なし)"
              try {
                Invoke-WebRequest -Uri $browserDownloadUrl -OutFile $outputPath -ErrorAction Stop
              } catch {
                Write-Output "❌ SDKのダウンロードに失敗しました"
                Write-Output "HTTPステータス: $($_.Exception.Response.StatusCode.value__)"
                Write-Output "エラーメッセージ: $($_.Exception.Message)"
                exit 1
              }
            } else {
              exit 1
            }
          }
          
          # ダウンロードしたファイルの確認
          if (-not (Test-Path $outputPath) -or (Get-Item $outputPath).Length -eq 0) {
            Write-Output "❌ ダウンロードしたファイルが無効です"
            exit 1
          }
          
          $fileSize = (Get-Item $outputPath).Length / 1MB
          Write-Output "✅ ダウンロード完了 ($([math]::Round($fileSize, 2)) MB)"
          
          # SDKを展開（テンポラリディレクトリへ）
          Write-Output "📦 SDKを展開中..."
          $extractDir = Join-Path $env:RUNNER_TEMP ("ae_sdk_" + [Guid]::NewGuid().ToString())
          New-Item -ItemType Directory -Path $extractDir -Force | Out-Null

          try {
            Expand-Archive -Path $outputPath -DestinationPath $extractDir -Force -ErrorAction Stop
          } catch {
            Write-Output "❌ SDKの展開に失敗しました: $($_.Exception.Message)"
            Get-ChildItem $extractDir -Recurse | Select-Object -First 40 | Format-Table FullName, LastWriteTime
            exit 1
          }

          function Get-SdkRoot([string]$root) {
            Get-ChildItem -Path $root -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object {
                Test-Path (Join-Path $_.FullName "Headers") -and
                Test-Path (Join-Path $_.FullName "Util")
              } |
              Select-Object -First 1
          }

          $sdkRoot = Get-SdkRoot -root $extractDir

          function Get-SdkSubDir([string]$pattern) {
            $match = Get-ChildItem -Path $extractDir -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -like $pattern } |
              Select-Object -First 1
            if ($match) {
              return $match.FullName
            }
            return $null
          }

          if ($sdkRoot) {
            $headersSrc = Join-Path $sdkRoot.FullName "Headers"
            $utilSrc    = Join-Path $sdkRoot.FullName "Util"
          } else {
            $headersSrc = Get-SdkSubDir "*AfterEffectsSDK*\\Headers"
            $utilSrc    = Get-SdkSubDir "*AfterEffectsSDK*\\Util"
          }

          if (-not $headersSrc) {
            $headersSrc = Get-ChildItem -Path $extractDir -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -ieq "Headers" } |
              Select-Object -First 1 |
              ForEach-Object { $_.FullName }
          }

          if (-not $utilSrc) {
            $utilSrc = Get-ChildItem -Path $extractDir -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -ieq "Util" } |
              Select-Object -First 1 |
              ForEach-Object { $_.FullName }
          }

          if (-not $headersSrc -or -not $utilSrc) {
            Write-Output "❌ SDK内に Headers/Util が見つかりません"
            Get-ChildItem $extractDir -Recurse -Directory | Select-Object -First 40 | Format-Table FullName
            exit 1
          }

          New-Item -ItemType Directory -Force -Path $EXPECTED_SDK_PATH | Out-Null
          Remove-Item -Recurse -Force (Join-Path $EXPECTED_SDK_PATH "Headers") -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force (Join-Path $EXPECTED_SDK_PATH "Util") -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Force $headersSrc (Join-Path $EXPECTED_SDK_PATH "Headers")
          Copy-Item -Recurse -Force $utilSrc (Join-Path $EXPECTED_SDK_PATH "Util")
          
          # 最終確認
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            $headerCount = (Get-ChildItem "$EXPECTED_SDK_PATH\Headers" -File | Measure-Object).Count
            $utilCount = (Get-ChildItem "$EXPECTED_SDK_PATH\Util" -File | Measure-Object).Count
            Write-Output "✅ AeSDKのセットアップが完了しました"
            Write-Output "📁 AeSDKパス: $EXPECTED_SDK_PATH"
            Write-Output "📁 Headers: $EXPECTED_SDK_PATH\Headers ($headerCount ファイル)"
            Write-Output "📁 Util: $EXPECTED_SDK_PATH\Util ($utilCount ファイル)"
          } else {
            Write-Output "❌ AeSDKのセットアップに失敗しました"
            Write-Output "想定パス: $EXPECTED_SDK_PATH"
            Write-Output "存在確認:"
            if (Test-Path "$EXPECTED_SDK_PATH") { Write-Output "  - ディレクトリは存在します" } else { Write-Output "  - ディレクトリが存在しません" }
            if (Test-Path "$EXPECTED_SDK_PATH\Headers") { Write-Output "  - Headers\ は存在します" } else { Write-Output "  - Headers\ が存在しません" }
            if (Test-Path "$EXPECTED_SDK_PATH\Util") { Write-Output "  - Util\ は存在します" } else { Write-Output "  - Util\ が存在しません" }
            Write-Output ""
            Write-Output "展開されたファイル:"
            $parentDir = Split-Path -Parent $EXPECTED_SDK_PATH
            Get-ChildItem $parentDir | Select-Object -First 20 | Format-Table Name, Length, LastWriteTime
            exit 1
          }

          # クリーンアップ
          Remove-Item $outputPath -Force -ErrorAction SilentlyContinue
          Remove-Item $extractDir -Recurse -Force -ErrorAction SilentlyContinue

      # 7. Mac用: Xcodeビルドの実行
      - name: Build Xcode Project (Unsigned)
        if: matrix.platform == 'mac'
        run: |
          set -e  # エラー時に即座に終了
          
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          echo "📁 プロジェクトディレクトリ: $PROJECT_DIR"
          echo "📁 ビルドディレクトリ: $BUILD_DIR"
          
          cd "$BUILD_DIR"
          
          # プロジェクトファイルの確認
          if [ ! -f "sep_color.xcodeproj/project.pbxproj" ]; then
            echo "❌ Xcodeプロジェクトファイルが見つかりません: $BUILD_DIR/sep_color.xcodeproj"
            exit 1
          fi
          
          echo "🔨 Xcodeビルドを開始します..."
          
          # xcodebuildを実行（エラーメッセージを表示）
          if ! xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Debug \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee xcodebuild.log; then
            echo "❌ Xcodeビルドに失敗しました"
            echo ""
            echo "ビルドログの最後の50行:"
            tail -50 xcodebuild.log || true
            echo ""
            echo "エラーメッセージ:"
            grep -i "error" xcodebuild.log | tail -20 || true
            exit 1
          fi
          
          echo "✅ Xcodeビルドが完了しました"
          
          # ビルド成果物の確認
          echo "📦 ビルド成果物を検索:"
          PLUGIN_PATH=$(find build -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            echo "✅ ビルド成果物が見つかりました: $PLUGIN_PATH"
            echo "📊 ファイルサイズ: $(du -h "$PLUGIN_PATH" | cut -f1)"
          else
            echo "⚠️  ビルド成果物が見つかりませんでした"
            echo "検索パス: $BUILD_DIR/build"
            find build -type d -name "*.plugin" 2>/dev/null || true
            echo ""
            echo "ビルドディレクトリの内容:"
            ls -la build 2>/dev/null || true
            exit 1
          fi

      # 8. Windows用: MSBuildビルドの実行
      - name: Build Visual Studio Project (Unsigned)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          # MSBuildでビルド
          msbuild sep_color.sln `
            /p:Configuration=Debug `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Debug\" `
            /t:Build `
            /v:minimal
          
          # ビルド成果物の確認
          Write-Output "📦 ビルド成果物を検索:"
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            Write-Output "✅ ビルド成果物が見つかりました: $($AEX_PATH.FullName)"
          } else {
            Write-Output "⚠️  ビルド成果物が見つかりませんでした"
            Get-ChildItem -Path "$BUILD_DIR\build" -Filter "*.aex" -Recurse -ErrorAction SilentlyContinue
          }

      # 9. Mac用: .pluginバンドルのZIP圧縮
      - name: Compress .plugin Bundle
        if: success() && matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-unsigned.zip"
            echo "✅ プラグインバンドルを圧縮しました: sep_color-macOS-unsigned.zip"
          fi

      # 10. Windows用: .aexファイルのZIP圧縮
      - name: Compress .aex File
        if: success() && matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-unsigned.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "✅ プラグインファイルを圧縮しました: sep_color-Windows-unsigned.zip"
          }

      # 11. テスト用アーティファクトのアップロード
      - name: Upload Test Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-unsigned
          path: |
            Template/sep_color/Mac/sep_color-macOS-unsigned.zip
            Template/sep_color/Win/sep_color-Windows-unsigned.zip
            sep_color/Mac/sep_color-macOS-unsigned.zip
            sep_color/Win/sep_color-Windows-unsigned.zip
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # ============================================
  # ジョブ2: リリースビルド (署名付き)
  # タグがプッシュされた時のみ実行 - Mac/Windows両方
  # ============================================
  build-release:
    name: Build, Sign, and Package Release
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}
    
    # タグがプッシュされた時のみ、このジョブを実行
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          set -e  # エラー時に即座に終了
          
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "✅ AeSDKが既に存在します"
            exit 0
          fi
          
          # GitHub APIを使用してリリース情報を取得
          # リリースタグの候補（優先順位順）
          RELEASE_TAG_CANDIDATES=("sdk" "ae-sdk_25.6_61" "v25.6.61" "25.6.61")
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "📦 GitHubリリースからAeSDKをダウンロードします"
          echo "   リポジトリ: $REPO"
          echo "   SDKファイル: ${{ matrix.sdk_file }}"
          
          # トークンの確認
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "❌ GITHUB_TOKENが設定されていません"
            exit 1
          fi
          
          # リリース情報を取得（複数のタグ候補を試す）
          RELEASE_JSON=""
          HTTP_STATUS=""
          FOUND_TAG=""
          
          for RELEASE_TAG in "${RELEASE_TAG_CANDIDATES[@]}"; do
            echo "🔍 リリース情報を取得中... (タグ: $RELEASE_TAG)"
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "📊 HTTPステータス: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG="$RELEASE_TAG"
              echo "✅ リリースを見つけました: $FOUND_TAG"
              break
            else
              echo "⚠️  タグ '$RELEASE_TAG' が見つかりませんでした (HTTP $HTTP_STATUS)"
            fi
          done
          
          # どのタグも見つからない場合、最新リリースを試す
          if [ -z "$FOUND_TAG" ]; then
            echo "⚠️  指定されたタグが見つかりません。最新リリースを取得します..."
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/latest" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "✅ 最新リリースを見つけました: $FOUND_TAG"
            fi
          fi
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "❌ リリース情報の取得に失敗しました (HTTP $HTTP_STATUS)"
            echo "$RELEASE_JSON" | head -30
            echo ""
            echo "考えられる原因:"
            echo "  1. リポジトリが存在しない、またはプライベートリポジトリでアクセス権限がない"
            echo "  2. リリースタグが存在しない（試したタグ: ${RELEASE_TAG_CANDIDATES[*]}）"
            echo "  3. GitHub Personal Access Token (PAT) の権限が不足している"
            echo "  4. AE_SDK_DOWNLOAD_TOKEN が正しく設定されていない"
            exit 1
          fi
          
          # アセットの情報を取得
          ASSET_NAME="${{ matrix.sdk_file }}"
          
          # JSONからアセット情報を抽出（より確実な方法）
          ASSET_INFO=$(echo "$RELEASE_JSON" | grep -A 30 "\"name\":\s*\"$ASSET_NAME\"" | head -30)
          
          if [ -z "$ASSET_INFO" ]; then
            echo "❌ SDKファイルが見つかりません: $ASSET_NAME"
            echo "利用可能なアセットの一覧:"
            echo "$RELEASE_JSON" | grep -o '"name":"[^"]*"' | head -10
            exit 1
          fi
          
          # browser_download_urlを取得
          DOWNLOAD_URL=$(echo "$ASSET_INFO" | grep -o "\"browser_download_url\":\s*\"[^\"]*\"" | head -1 | cut -d'"' -f4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "❌ ダウンロードURLが見つかりません: $ASSET_NAME"
            echo "アセット情報:"
            echo "$ASSET_INFO" | head -20
            exit 1
          fi
          
          echo "📥 ダウンロードURL: $DOWNLOAD_URL"
          
          # SDKをダウンロード（認証ヘッダーを付ける）
          echo "⬇️  SDKをダウンロード中..."
          echo "   ダウンロードURL: $DOWNLOAD_URL"
          echo "   認証: $([ -n "$GITHUB_TOKEN" ] && echo "あり" || echo "なし")"
          
          # まず認証付きで試す
          CURL_OUTPUT=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -H "User-Agent: GitHub-Actions" \
               -o AE_SDK.zip \
               -s -S "$DOWNLOAD_URL" 2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_STATUS=$(echo "$CURL_OUTPUT" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
          
          # エラーメッセージを取得（HTTP_STATUS行を除く）
          CURL_ERROR=$(echo "$CURL_OUTPUT" | grep -v "HTTP_STATUS:" || echo "")
          
          echo "📊 HTTPステータス: $HTTP_STATUS"
          echo "📊 curl終了コード: $CURL_EXIT_CODE"
          
          if [ -n "$CURL_ERROR" ]; then
            echo "📊 curlエラーメッセージ:"
            echo "$CURL_ERROR" | head -10
          fi
          
          # HTTPステータスが200でない場合、またはcurlが失敗した場合
          if [ "$HTTP_STATUS" != "200" ] || [ "$CURL_EXIT_CODE" != "0" ]; then
            echo "⚠️  認証付きダウンロードに失敗しました (HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE)"
            
            # ファイルが存在する場合は削除
            [ -f "AE_SDK.zip" ] && rm -f AE_SDK.zip
            
            # 認証なしで試す（パブリックリポジトリの場合）
            echo "試行: 認証なしでダウンロードを試みます..."
            CURL_OUTPUT2=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
                 -H "Accept: application/octet-stream" \
                 -H "User-Agent: GitHub-Actions" \
                 -o AE_SDK.zip \
                 -s -S "$DOWNLOAD_URL" 2>&1)
            
            CURL_EXIT_CODE2=$?
            HTTP_STATUS2=$(echo "$CURL_OUTPUT2" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
            CURL_ERROR2=$(echo "$CURL_OUTPUT2" | grep -v "HTTP_STATUS:" || echo "")
            
            echo "📊 HTTPステータス (認証なし): $HTTP_STATUS2"
            echo "📊 curl終了コード (認証なし): $CURL_EXIT_CODE2"
            
            if [ -n "$CURL_ERROR2" ]; then
              echo "📊 curlエラーメッセージ (認証なし):"
              echo "$CURL_ERROR2" | head -10
            fi
            
            if [ "$HTTP_STATUS2" != "200" ] || [ "$CURL_EXIT_CODE2" != "0" ]; then
              echo "❌ SDKのダウンロードに失敗しました"
              echo ""
              echo "デバッグ情報:"
              echo "  ダウンロードURL: $DOWNLOAD_URL"
              echo "  認証付き: HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE"
              echo "  認証なし: HTTP $HTTP_STATUS2, exit $CURL_EXIT_CODE2"
              echo "  トークン設定: $([ -n "$GITHUB_TOKEN" ] && echo "あり (長さ: ${#GITHUB_TOKEN})" || echo "なし")"
              echo ""
              echo "考えられる原因:"
              echo "  1. GitHub Personal Access Token (PAT) の権限が不足している"
              echo "  2. プライベートリポジトリへのアクセス権限がない"
              echo "  3. トークンが期限切れまたは無効"
              echo "  4. ダウンロードURLが無効またはアクセスできない"
              echo "  5. ネットワークエラーまたはタイムアウト"
              exit 1
            else
              echo "✅ 認証なしでダウンロード成功"
            fi
          else
            echo "✅ 認証付きでダウンロード成功"
          fi
          
          if [ ! -f "AE_SDK.zip" ] || [ ! -s "AE_SDK.zip" ]; then
            echo "❌ ダウンロードしたファイルが無効です"
            exit 1
          fi
          
          echo "✅ ダウンロード完了 ($(du -h AE_SDK.zip | cut -f1))"
          
          mkdir -p "$(dirname "$EXPECTED_SDK_PATH")"
          echo "📦 SDKを展開中..."
          unzip -q AE_SDK.zip -d "$(dirname "$EXPECTED_SDK_PATH")" || {
            unzip -q AE_SDK.zip
            [ -d "Adobe-AE-SDK" ] && mv Adobe-AE-SDK "$EXPECTED_SDK_PATH" || \
            [ -d "SDK" ] && mv SDK "$EXPECTED_SDK_PATH" || \
            mkdir -p "$EXPECTED_SDK_PATH" && find . -maxdepth 1 -type d \( -name "Headers" -o -name "Util" \) -exec mv {} "$EXPECTED_SDK_PATH/" \;
          }
          rm -f AE_SDK.zip
          
          if [ ! -d "$EXPECTED_SDK_PATH/Headers" ] || [ ! -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "❌ AeSDKのセットアップに失敗しました"
            exit 1
          fi
          
          echo "✅ AeSDKのセットアップが完了しました"

      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        shell: powershell
        run: |
          $EXPECTED_SDK_PATH = "${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "✅ AeSDKが既に存在します"
            exit 0
          }
          
          # リリースタグの候補（優先順位順）
          $RELEASE_TAG_CANDIDATES = @("sdk", "ae-sdk_25.6_61", "v25.6.61", "25.6.61")
          $REPO = "rebuildup/my-ae-sdk-storage"
          
          Write-Output "📦 GitHubリリースからAeSDKをダウンロードします"
          Write-Output "   リポジトリ: $REPO"
          Write-Output "   SDKファイル: ${{ matrix.sdk_file }}"
          
          # トークンの確認
          if (-not $env:GITHUB_TOKEN) {
            Write-Output "❌ GITHUB_TOKENが設定されていません"
            exit 1
          }
          
          # リリース情報を取得（複数のタグ候補を試す）
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept = "application/vnd.github.v3+json"
          }
          
          $releaseJson = $null
          $foundTag = $null
          
          foreach ($RELEASE_TAG in $RELEASE_TAG_CANDIDATES) {
            Write-Output "🔍 リリース情報を取得中... (タグ: $RELEASE_TAG)"
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $RELEASE_TAG
              Write-Output "✅ リリースを見つけました: $foundTag"
              break
            } catch {
              $statusCode = $_.Exception.Response.StatusCode.value__
              Write-Output "⚠️  タグ '$RELEASE_TAG' が見つかりませんでした (HTTP $statusCode)"
            }
          }
          
          # どのタグも見つからない場合、最新リリースを試す
          if (-not $releaseJson) {
            Write-Output "⚠️  指定されたタグが見つかりません。最新リリースを取得します..."
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/latest"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $releaseJson.tag_name
              Write-Output "✅ 最新リリースを見つけました: $foundTag"
            } catch {
              Write-Output "❌ リリース情報の取得に失敗しました"
              Write-Output "HTTPステータス: $($_.Exception.Response.StatusCode.value__)"
              Write-Output "エラーメッセージ: $($_.Exception.Message)"
              exit 1
            }
          }
          
          # アセットの情報を取得（認証が必要な場合はAPIエンドポイントを使用）
          $assetName = "${{ matrix.sdk_file }}"
          $asset = $releaseJson.assets | Where-Object { $_.name -eq $assetName }
          
          if (-not $asset) {
            Write-Output "❌ SDKファイルが見つかりません: $assetName"
            Write-Output "利用可能なアセット:"
            $releaseJson.assets | ForEach-Object { Write-Output "   - $($_.name)" }
            exit 1
          }
          
          # 認証が必要な場合はAPIエンドポイントを使用、そうでない場合はbrowser_download_urlを使用
          if ($asset.url) {
            $downloadUrl = $asset.url
            Write-Output "📥 APIエンドポイントを使用: $downloadUrl"
          } else {
            $downloadUrl = $asset.browser_download_url
            Write-Output "📥 ブラウザダウンロードURLを使用: $downloadUrl"
          }
          
          Write-Output "⬇️  SDKをダウンロード中..."
          
          try {
            Invoke-WebRequest -Uri $downloadUrl -Headers $headers -OutFile "AE_SDK.zip" -ErrorAction Stop
            Write-Output "✅ ダウンロード成功"
          } catch {
            $statusCode = $_.Exception.Response.StatusCode.value__
            $errorMessage = $_.Exception.Message
            Write-Output "❌ SDKのダウンロードに失敗しました"
            Write-Output "HTTPステータス: $statusCode"
            Write-Output "エラーメッセージ: $errorMessage"
            Write-Output ""
            Write-Output "デバッグ情報:"
            Write-Output "  ダウンロードURL: $downloadUrl"
            Write-Output "  トークン設定: $(if ($env:GITHUB_TOKEN) { 'あり' } else { 'なし' })"
            Write-Output ""
            Write-Output "考えられる原因:"
            Write-Output "  1. GitHub Personal Access Token (PAT) の権限が不足している"
            Write-Output "  2. プライベートリポジトリへのアクセス権限がない"
            Write-Output "  3. トークンが期限切れまたは無効"
            exit 1
          }
          
          if (-not (Test-Path "AE_SDK.zip") -or (Get-Item "AE_SDK.zip").Length -eq 0) {
            Write-Output "❌ ダウンロードしたファイルが無効です"
            exit 1
          }
          
          $fileSize = (Get-Item "AE_SDK.zip").Length / 1MB
          Write-Output "✅ ダウンロード完了 ($([math]::Round($fileSize, 2)) MB)"
          
          $parentDir = Split-Path -Parent $EXPECTED_SDK_PATH
          New-Item -ItemType Directory -Force -Path $parentDir | Out-Null
          Expand-Archive -Path "AE_SDK.zip" -DestinationPath $parentDir -Force
          
          if (Test-Path "$parentDir\Adobe-AE-SDK") {
            Move-Item "$parentDir\Adobe-AE-SDK" $EXPECTED_SDK_PATH -Force
          } elseif (Test-Path "$parentDir\SDK") {
            Move-Item "$parentDir\SDK" $EXPECTED_SDK_PATH -Force
          } elseif ((Test-Path "$parentDir\Headers") -or (Test-Path "$parentDir\Util")) {
            New-Item -ItemType Directory -Force -Path $EXPECTED_SDK_PATH | Out-Null
            if (Test-Path "$parentDir\Headers") { Move-Item "$parentDir\Headers" $EXPECTED_SDK_PATH -Force }
            if (Test-Path "$parentDir\Util") { Move-Item "$parentDir\Util" $EXPECTED_SDK_PATH -Force }
          }
          
          Remove-Item "AE_SDK.zip" -Force
          
          if (-not ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util"))) {
            Write-Output "❌ AeSDKのセットアップに失敗しました"
            exit 1
          }

      # Mac用: キーチェーン・スクリプト（コードサイニング用）
      - name: Install Apple Certificate and Profile
        if: matrix.platform == 'mac'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/
          mkdir -p "$PROFILE_PATH"
          PROVISIONING_PROFILE_PATH=$RUNNER_TEMP/profile.provisionprofile
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PROVISIONING_PROFILE_PATH
          cp $PROVISIONING_PROFILE_PATH "$PROFILE_PATH"

      # Mac用: Xcodeビルドの実行 (署名あり)
      - name: Build Xcode Project (Signed)
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR"
          
          xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Release \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build"

      # Windows用: MSBuildビルドの実行 (Release)
      - name: Build Visual Studio Project (Release)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          msbuild sep_color.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Release\" `
            /t:Build `
            /v:minimal

      # Mac用: .pluginバンドルのZIP圧縮
      - name: Compress .plugin Bundle
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-${{ github.ref_name }}.zip"
            echo "✅ プラグインバンドルを圧縮しました"
          fi

      # Windows用: .aexファイルのZIP圧縮
      - name: Compress .aex File
        if: matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-${{ github.ref_name }}.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "✅ プラグインファイルを圧縮しました"
          }

      # リリース用アーティファクトのアップロード
      - name: Upload Release Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-${{ github.ref_name }}
          path: |
            Template/sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            Template/sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
            sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
          retention-days: 90
          if-no-files-found: warn
          compression-level: 6
