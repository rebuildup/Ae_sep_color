name: Build After Effects Plugin

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (main/master/developãƒ–ãƒ©ãƒ³ãƒå¯¾è±¡) ã§ãƒˆãƒªã‚¬ãƒ¼
  pull_request:
    branches: [ main, master, develop ]
  
  # 'v'ã§å§‹ã¾ã‚‹ã‚¿ã‚° (ä¾‹: v1.0.0) ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  # ============================================
  # ã‚¸ãƒ§ãƒ–1: ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ (ç½²åãªã—)
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼ç”¨ - Mac/Windowsä¸¡æ–¹
  # ============================================
  build-test:
    name: Build and Test (Unsigned)
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. Macç”¨: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®š
      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # 3. Macç”¨: Xcodeãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®åŒæ„
      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      # 4. Windowsç”¨: Visual Studio ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      # 5. Macç”¨: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã®ç¢ºèª
      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      # 5. Windowsç”¨: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã®ç¢ºèª
      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # 5.5. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã‚’çµ±åˆ
      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 6. Macç”¨: GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AE SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDKãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: $EXPECTED_SDK_PATH"
            exit 0
          fi
          
          # GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          RELEASE_TAG="ae-sdk_25.6_61"
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "ğŸ“¦ GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AeSDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
          echo "   ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
          echo "   ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: $RELEASE_TAG"
          echo "   SDKãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.sdk_file }}"
          
          # ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          RELEASE_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG")
          
          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | grep -q '"message":"Not Found"'; then
            echo "âŒ ãƒªãƒªãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $RELEASE_TAG"
            exit 1
          fi
          
          # ã‚¢ã‚»ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
          DOWNLOAD_URL=$(echo "$RELEASE_JSON" | grep -o "\"browser_download_url\":\s*\"[^\"]*${{ matrix.sdk_file }}[^\"]*\"" | head -1 | cut -d'"' -f4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ matrix.sdk_file }}"
            echo "åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ:"
            echo "$RELEASE_JSON" | grep -o "\"name\":\s*\"[^\"]*\"" | head -5
            exit 1
          fi
          
          echo "ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: $DOWNLOAD_URL"
          
          # SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -o AE_SDK.zip "$DOWNLOAD_URL" || {
            echo "âŒ SDKã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          
          # è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆ
          mkdir -p "$(dirname "$EXPECTED_SDK_PATH")"
          
          # SDKã‚’å±•é–‹
          unzip -q AE_SDK.zip -d "$(dirname "$EXPECTED_SDK_PATH")" || {
            # ZIPã®ãƒ«ãƒ¼ãƒˆã«SDKãŒã‚ã‚‹å ´åˆ
            unzip -q AE_SDK.zip
            if [ -d "Adobe-AE-SDK" ]; then
              mv Adobe-AE-SDK "$EXPECTED_SDK_PATH"
            elif [ -d "SDK" ]; then
              mv SDK "$EXPECTED_SDK_PATH"
            else
              # å±•é–‹ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç§»å‹•
              mkdir -p "$EXPECTED_SDK_PATH"
              find . -maxdepth 1 -type d \( -name "Headers" -o -name "Util" \) -exec mv {} "$EXPECTED_SDK_PATH/" \;
            fi
          }
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f AE_SDK.zip
          
          # æœ€çµ‚ç¢ºèª
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âœ… AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
            echo "ğŸ“ AeSDKãƒ‘ã‚¹: $EXPECTED_SDK_PATH"
          else
            echo "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      # 6. Windowsç”¨: GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AE SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        shell: powershell
        run: |
          $EXPECTED_SDK_PATH = "${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDKãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: $EXPECTED_SDK_PATH"
            exit 0
          }
          
          # GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          $RELEASE_TAG = "ae-sdk_25.6_61"
          $REPO = "rebuildup/my-ae-sdk-storage"
          
          Write-Output "ğŸ“¦ GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AeSDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
          Write-Output "   ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
          Write-Output "   ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: $RELEASE_TAG"
          Write-Output "   SDKãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.sdk_file }}"
          
          # ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
          }
          $releaseUrl = "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
          $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers
          
          # ã‚¢ã‚»ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
          $downloadUrl = ($releaseJson.assets | Where-Object { $_.name -eq "${{ matrix.sdk_file }}" }).browser_download_url
          
          if (-not $downloadUrl) {
            Write-Output "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ matrix.sdk_file }}"
            Write-Output "åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ:"
            $releaseJson.assets | ForEach-Object { Write-Output "  - $($_.name)" }
            exit 1
          }
          
          Write-Output "ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: $downloadUrl"
          
          # SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          $outputPath = "AE_SDK.zip"
          Invoke-WebRequest -Uri $downloadUrl -Headers $headers -OutFile $outputPath
          
          # è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆ
          $parentDir = Split-Path -Parent $EXPECTED_SDK_PATH
          New-Item -ItemType Directory -Force -Path $parentDir | Out-Null
          
          # SDKã‚’å±•é–‹
          Expand-Archive -Path $outputPath -DestinationPath $parentDir -Force
          
          # ZIPã®ãƒ«ãƒ¼ãƒˆã«SDKãŒã‚ã‚‹å ´åˆã®å‡¦ç†
          if (Test-Path "$parentDir\Adobe-AE-SDK") {
            Move-Item "$parentDir\Adobe-AE-SDK" $EXPECTED_SDK_PATH -Force
          } elseif (Test-Path "$parentDir\SDK") {
            Move-Item "$parentDir\SDK" $EXPECTED_SDK_PATH -Force
          } elseif ((Test-Path "$parentDir\Headers") -or (Test-Path "$parentDir\Util")) {
            New-Item -ItemType Directory -Force -Path $EXPECTED_SDK_PATH | Out-Null
            if (Test-Path "$parentDir\Headers") { Move-Item "$parentDir\Headers" $EXPECTED_SDK_PATH -Force }
            if (Test-Path "$parentDir\Util") { Move-Item "$parentDir\Util" $EXPECTED_SDK_PATH -Force }
          }
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          Remove-Item $outputPath -Force
          
          # æœ€çµ‚ç¢ºèª
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "âœ… AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
            Write-Output "ğŸ“ AeSDKãƒ‘ã‚¹: $EXPECTED_SDK_PATH"
          } else {
            Write-Output "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      # 7. Macç”¨: Xcodeãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
      - name: Build Xcode Project (Unsigned)
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR"
          
          xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Debug \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
          
          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’æ¤œç´¢:"
          PLUGIN_PATH=$(find build -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $PLUGIN_PATH"
          else
            echo "âš ï¸  ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            find build -type d -name "*.plugin" 2>/dev/null || true
          fi

      # 8. Windowsç”¨: MSBuildãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
      - name: Build Visual Studio Project (Unsigned)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          # MSBuildã§ãƒ“ãƒ«ãƒ‰
          msbuild sep_color.sln `
            /p:Configuration=Debug `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Debug\" `
            /t:Build `
            /v:minimal
          
          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
          Write-Output "ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’æ¤œç´¢:"
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            Write-Output "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $($AEX_PATH.FullName)"
          } else {
            Write-Output "âš ï¸  ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            Get-ChildItem -Path "$BUILD_DIR\build" -Filter "*.aex" -Recurse -ErrorAction SilentlyContinue
          }

      # 9. Macç”¨: .pluginãƒãƒ³ãƒ‰ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .plugin Bundle
        if: success() && matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-unsigned.zip"
            echo "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ: sep_color-macOS-unsigned.zip"
          fi

      # 10. Windowsç”¨: .aexãƒ•ã‚¡ã‚¤ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .aex File
        if: success() && matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-unsigned.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ: sep_color-Windows-unsigned.zip"
          }

      # 11. ãƒ†ã‚¹ãƒˆç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Test Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-unsigned
          path: |
            Template/sep_color/Mac/sep_color-macOS-unsigned.zip
            Template/sep_color/Win/sep_color-Windows-unsigned.zip
            sep_color/Mac/sep_color-macOS-unsigned.zip
            sep_color/Win/sep_color-Windows-unsigned.zip
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # ============================================
  # ã‚¸ãƒ§ãƒ–2: ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ (ç½²åä»˜ã)
  # ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ - Mac/Windowsä¸¡æ–¹
  # ============================================
  build-release:
    name: Build, Sign, and Package Release
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}
    
    # ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã®ã¿ã€ã“ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
            exit 0
          fi
          
          RELEASE_TAG="ae-sdk_25.6_61"
          REPO="rebuildup/my-ae-sdk-storage"
          
          RELEASE_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG")
          
          DOWNLOAD_URL=$(echo "$RELEASE_JSON" | grep -o "\"browser_download_url\":\s*\"[^\"]*${{ matrix.sdk_file }}[^\"]*\"" | head -1 | cut -d'"' -f4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ matrix.sdk_file }}"
            exit 1
          fi
          
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -o AE_SDK.zip "$DOWNLOAD_URL" || exit 1
          
          mkdir -p "$(dirname "$EXPECTED_SDK_PATH")"
          unzip -q AE_SDK.zip -d "$(dirname "$EXPECTED_SDK_PATH")" || {
            unzip -q AE_SDK.zip
            [ -d "Adobe-AE-SDK" ] && mv Adobe-AE-SDK "$EXPECTED_SDK_PATH" || \
            [ -d "SDK" ] && mv SDK "$EXPECTED_SDK_PATH" || \
            mkdir -p "$EXPECTED_SDK_PATH" && find . -maxdepth 1 -type d \( -name "Headers" -o -name "Util" \) -exec mv {} "$EXPECTED_SDK_PATH/" \;
          }
          rm -f AE_SDK.zip
          
          if [ ! -d "$EXPECTED_SDK_PATH/Headers" ] || [ ! -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        shell: powershell
        run: |
          $EXPECTED_SDK_PATH = "${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
            exit 0
          }
          
          $RELEASE_TAG = "ae-sdk_25.6_61"
          $REPO = "rebuildup/my-ae-sdk-storage"
          
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
          }
          $releaseUrl = "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
          $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers
          
          $downloadUrl = ($releaseJson.assets | Where-Object { $_.name -eq "${{ matrix.sdk_file }}" }).browser_download_url
          
          if (-not $downloadUrl) {
            Write-Output "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ matrix.sdk_file }}"
            exit 1
          }
          
          Invoke-WebRequest -Uri $downloadUrl -Headers $headers -OutFile "AE_SDK.zip"
          
          $parentDir = Split-Path -Parent $EXPECTED_SDK_PATH
          New-Item -ItemType Directory -Force -Path $parentDir | Out-Null
          Expand-Archive -Path "AE_SDK.zip" -DestinationPath $parentDir -Force
          
          if (Test-Path "$parentDir\Adobe-AE-SDK") {
            Move-Item "$parentDir\Adobe-AE-SDK" $EXPECTED_SDK_PATH -Force
          } elseif (Test-Path "$parentDir\SDK") {
            Move-Item "$parentDir\SDK" $EXPECTED_SDK_PATH -Force
          } elseif ((Test-Path "$parentDir\Headers") -or (Test-Path "$parentDir\Util")) {
            New-Item -ItemType Directory -Force -Path $EXPECTED_SDK_PATH | Out-Null
            if (Test-Path "$parentDir\Headers") { Move-Item "$parentDir\Headers" $EXPECTED_SDK_PATH -Force }
            if (Test-Path "$parentDir\Util") { Move-Item "$parentDir\Util" $EXPECTED_SDK_PATH -Force }
          }
          
          Remove-Item "AE_SDK.zip" -Force
          
          if (-not ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util"))) {
            Write-Output "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }

      # Macç”¨: ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‹ãƒ³ã‚°ç”¨ï¼‰
      - name: Install Apple Certificate and Profile
        if: matrix.platform == 'mac'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/
          mkdir -p "$PROFILE_PATH"
          PROVISIONING_PROFILE_PATH=$RUNNER_TEMP/profile.provisionprofile
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PROVISIONING_PROFILE_PATH
          cp $PROVISIONING_PROFILE_PATH "$PROFILE_PATH"

      # Macç”¨: Xcodeãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ (ç½²åã‚ã‚Š)
      - name: Build Xcode Project (Signed)
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR"
          
          xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Release \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build"

      # Windowsç”¨: MSBuildãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ (Release)
      - name: Build Visual Studio Project (Release)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          msbuild sep_color.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Release\" `
            /t:Build `
            /v:minimal

      # Macç”¨: .pluginãƒãƒ³ãƒ‰ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .plugin Bundle
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-${{ github.ref_name }}.zip"
            echo "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ"
          fi

      # Windowsç”¨: .aexãƒ•ã‚¡ã‚¤ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .aex File
        if: matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-${{ github.ref_name }}.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ"
          }

      # ãƒªãƒªãƒ¼ã‚¹ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Release Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-${{ github.ref_name }}
          path: |
            Template/sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            Template/sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
            sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
          retention-days: 90
          if-no-files-found: warn
          compression-level: 6
