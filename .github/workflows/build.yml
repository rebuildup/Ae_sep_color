name: Build After Effects Plugin

on:
  pull_request:
    branches: [ main, master, develop ]
  
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  
  workflow_dispatch:

jobs:
  # ============================================
  # ã‚¸ãƒ§ãƒ–1: ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ (ç½²åãªã—)
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼ç”¨ - Mac/Windowsä¸¡æ–¹
  # ============================================
  build-test:
    name: Build and Test (Unsigned)
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. Macç”¨: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®š
      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # 3. Macç”¨: Xcodeãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®åŒæ„
      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      # 4. Windowsç”¨: Visual Studio ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      # 5. Macç”¨: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã®ç¢ºèª
      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      # 5. Windowsç”¨: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã®ç¢ºèª
      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # 5.5. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã‚’çµ±åˆ
      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 6. Macç”¨: GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AE SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†
          
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDKãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: $EXPECTED_SDK_PATH"
            exit 0
          fi
          
          # GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®å€™è£œï¼ˆå„ªå…ˆé †ä½é †ï¼‰
          RELEASE_TAG_CANDIDATES=("sdk" "ae-sdk_25.6_61" "v25.6.61" "25.6.61")
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "ðŸ“¦ GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AeSDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
          echo "   ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
          echo "   SDKãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.sdk_file }}"
          
          # ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ GITHUB_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "   GitHub Secretsã« AE_SDK_DOWNLOAD_TOKEN ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ã‚¿ã‚°å€™è£œã‚’è©¦ã™ï¼‰
          RELEASE_JSON=""
          HTTP_STATUS=""
          FOUND_TAG=""
          
          for RELEASE_TAG in "${RELEASE_TAG_CANDIDATES[@]}"; do
            echo "ðŸ” ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­... (ã‚¿ã‚°: $RELEASE_TAG)"
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG="$RELEASE_TAG"
              echo "âœ… ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $FOUND_TAG"
              break
            else
              echo "âš ï¸  ã‚¿ã‚° '$RELEASE_TAG' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (HTTP $HTTP_STATUS)"
            fi
          done
          
          # ã©ã®ã‚¿ã‚°ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è©¦ã™
          if [ -z "$FOUND_TAG" ]; then
            echo "âš ï¸  æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—ã—ã¾ã™..."
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/latest" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "âœ… æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $FOUND_TAG"
            fi
          fi
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_STATUS)"
            echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
            echo "$RELEASE_JSON" | head -30
            echo ""
            echo "è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
            echo "  1. ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„"
            echo "  2. ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„ï¼ˆè©¦ã—ãŸã‚¿ã‚°: ${RELEASE_TAG_CANDIDATES[*]}ï¼‰"
            echo "  3. GitHub Personal Access Token (PAT) ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹"
            echo "  4. AE_SDK_DOWNLOAD_TOKEN ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„"
            echo ""
            echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            echo "  ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
            echo "  è©¦ã—ãŸã‚¿ã‚°: ${RELEASE_TAG_CANDIDATES[*]}"
            exit 1
          fi
          
          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | grep -q '"message":"Not Found"'; then
            echo "âŒ ãƒªãƒªãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
            echo "$RELEASE_JSON" | head -30
            exit 1
          fi
          
          # ã‚¢ã‚»ãƒƒãƒˆã®ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "ðŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ:"
          echo "$RELEASE_JSON" | jq -r '.assets[]?.name' | head -10 | while read name; do
            [ -n "$name" ] && echo "   - $name"
          done

          # ã‚¢ã‚»ãƒƒãƒˆã®æƒ…å ±ã‚’å–å¾—
          ASSET_NAME="${{ matrix.sdk_file }}"
          ASSET_JSON=$(echo "$RELEASE_JSON" | jq -c --arg name "$ASSET_NAME" '.assets[]? | select(.name == $name)' | head -1)

          if [ -z "$ASSET_JSON" ]; then
            echo "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $ASSET_NAME"
            echo "åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆã®ä¸€è¦§:"
            echo "$RELEASE_JSON" | jq -r '.assets[]?.name' | head -10
            exit 1
          fi

          API_DOWNLOAD_URL=$(echo "$ASSET_JSON" | jq -r '.url // empty')
          BROWSER_DOWNLOAD_URL=$(echo "$ASSET_JSON" | jq -r '.browser_download_url // empty')

          if [ -z "$API_DOWNLOAD_URL" ]; then
            echo "âŒ APIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒå–å¾—ã§ãã¾ã›ã‚“"
            echo "$ASSET_JSON"
            exit 1
          fi

          echo "ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL(API): $API_DOWNLOAD_URL"
          [ -n "$BROWSER_DOWNLOAD_URL" ] && echo "ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL(ãƒ–ãƒ©ã‚¦ã‚¶): $BROWSER_DOWNLOAD_URL"
          
          # SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã‚‹ï¼‰
          echo "â¬‡ï¸  SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
          echo "   ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: ${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}"
          echo "   èªè¨¼: $([ -n "$GITHUB_TOKEN" ] && echo "ã‚ã‚Š" || echo "ãªã—")"
          
          # ã¾ãšèªè¨¼ä»˜ãã§è©¦ã™
          CURL_OUTPUT=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -H "User-Agent: GitHub-Actions" \
               -o AE_SDK.zip \
               -s -S "$API_DOWNLOAD_URL" 2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_STATUS=$(echo "$CURL_OUTPUT" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
          
          # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆHTTP_STATUSè¡Œã‚’é™¤ãï¼‰
          CURL_ERROR=$(echo "$CURL_OUTPUT" | grep -v "HTTP_STATUS:" || echo "")
          
          echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_STATUS"
          echo "ðŸ“Š curlçµ‚äº†ã‚³ãƒ¼ãƒ‰: $CURL_EXIT_CODE"
          
          if [ -n "$CURL_ERROR" ]; then
            echo "ðŸ“Š curlã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
            echo "$CURL_ERROR" | head -10
          fi
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200ã§ãªã„å ´åˆã€ã¾ãŸã¯curlãŒå¤±æ•—ã—ãŸå ´åˆ
          if [ "$HTTP_STATUS" != "200" ] || [ "$CURL_EXIT_CODE" != "0" ]; then
            echo "âš ï¸  èªè¨¼ä»˜ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE)"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
            [ -f "AE_SDK.zip" ] && rm -f AE_SDK.zip
            
            # èªè¨¼ãªã—ã§è©¦ã™ï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆï¼‰
            echo "è©¦è¡Œ: èªè¨¼ãªã—ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã¾ã™..."
            CURL_OUTPUT2=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
                 -H "Accept: application/octet-stream" \
                 -H "User-Agent: GitHub-Actions" \
                 -o AE_SDK.zip \
                 -s -S "${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}" 2>&1)
            
            CURL_EXIT_CODE2=$?
            HTTP_STATUS2=$(echo "$CURL_OUTPUT2" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
            CURL_ERROR2=$(echo "$CURL_OUTPUT2" | grep -v "HTTP_STATUS:" || echo "")
            
            echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (èªè¨¼ãªã—): $HTTP_STATUS2"
            echo "ðŸ“Š curlçµ‚äº†ã‚³ãƒ¼ãƒ‰ (èªè¨¼ãªã—): $CURL_EXIT_CODE2"
            
            if [ -n "$CURL_ERROR2" ]; then
              echo "ðŸ“Š curlã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (èªè¨¼ãªã—):"
              echo "$CURL_ERROR2" | head -10
            fi
            
            if [ "$HTTP_STATUS2" != "200" ] || [ "$CURL_EXIT_CODE2" != "0" ]; then
              echo "âŒ SDKã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo ""
              echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
              echo "  ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: ${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}"
              echo "  èªè¨¼ä»˜ã: HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE"
              echo "  èªè¨¼ãªã—: HTTP $HTTP_STATUS2, exit $CURL_EXIT_CODE2"
              echo "  ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š: $([ -n "$GITHUB_TOKEN" ] && echo "ã‚ã‚Š (é•·ã•: ${#GITHUB_TOKEN})" || echo "ãªã—")"
              echo ""
              echo "è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
              echo "  1. GitHub Personal Access Token (PAT) ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹"
              echo "  2. ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„"
              echo "  3. ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ç„¡åŠ¹"
              echo "  4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒç„¡åŠ¹ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„"
              echo "  5. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
              exit 1
            else
              echo "âœ… èªè¨¼ãªã—ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
            fi
          else
            echo "âœ… èªè¨¼ä»˜ãã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
          fi
          
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -f "AE_SDK.zip" ] || [ ! -s "AE_SDK.zip" ]; then
            echo "âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã§ã™"
            exit 1
          fi
          
          echo "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº† ($(du -h AE_SDK.zip | cut -f1))"
          
          # SDKã‚’å±•é–‹ï¼ˆãƒ†ãƒ³ãƒãƒ©ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ï¼‰
          echo "ðŸ“¦ SDKã‚’å±•é–‹ä¸­..."
          EXTRACT_DIR=$(mktemp -d)
          if ! unzip -q AE_SDK.zip -d "$EXTRACT_DIR"; then
            echo "âŒ SDKã®å±•é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ"
            ls -la "$EXTRACT_DIR" || true
            exit 1
          fi

          HEADERS_SRC=""
          UTIL_SRC=""

          extract_archive_file() {
            local archive="$1"
            local destination="$2"
            local lower
            lower=$(printf '%s' "$archive" | tr '[:upper:]' '[:lower:]')

            mkdir -p "$destination"

            if [[ "$lower" == *.tar.zst || "$lower" == *.tar.zstd ]]; then
              if tar --help 2>&1 | grep -q -- "--zstd"; then
                tar --zstd -xf "$archive" -C "$destination"
              elif command -v zstd >/dev/null 2>&1; then
                local tmp_tar="$destination/$(basename "${archive%.*}").tar"
                zstd -d "$archive" -o "$tmp_tar"
                tar -xf "$tmp_tar" -C "$destination"
                rm -f "$tmp_tar"
              else
                echo "âš ï¸  zstdã‚³ãƒžãƒ³ãƒ‰ãŒç„¡ã„ãŸã‚å±•é–‹ã§ãã¾ã›ã‚“: $archive"
                return 1
              fi
            elif [[ "$lower" == *.tar.gz || "$lower" == *.tgz ]]; then
              tar -xzf "$archive" -C "$destination"
            elif [[ "$lower" == *.tar.bz2 || "$lower" == *.tbz || "$lower" == *.tbz2 ]]; then
              tar -xjf "$archive" -C "$destination"
            elif [[ "$lower" == *.tar.xz || "$lower" == *.txz ]]; then
              tar -xJf "$archive" -C "$destination"
            elif [[ "$lower" == *.tar ]]; then
              tar -xf "$archive" -C "$destination"
            elif [[ "$lower" == *.zst || "$lower" == *.zstd ]]; then
              if command -v zstd >/dev/null 2>&1; then
                local output="$destination/$(basename "${archive%.*}")"
                zstd -d "$archive" -o "$output"
              else
                echo "âš ï¸  zstdã‚³ãƒžãƒ³ãƒ‰ãŒç„¡ã„ãŸã‚å±•é–‹ã§ãã¾ã›ã‚“: $archive"
                return 1
              fi
            elif [[ "$lower" == *.gz ]]; then
              gunzip -c "$archive" > "$destination/$(basename "${archive%.*}")"
            elif [[ "$lower" == *.bz2 ]]; then
              bunzip2 -c "$archive" > "$destination/$(basename "${archive%.*}")"
            elif [[ "$lower" == *.xz ]]; then
              unxz -c "$archive" > "$destination/$(basename "${archive%.*}")"
            elif [[ "$lower" == *.zip ]]; then
              unzip -q "$archive" -d "$destination"
            else
              return 1
            fi

            return 0
          }

          extract_nested_archives() {
            local iteration=0
            while [ $iteration -lt 6 ]; do
              local found=0
              while IFS= read -r -d '' archive; do
                [ -f "$archive" ] || continue
                local base
                base=$(basename "$archive")
                local dest="$EXTRACT_DIR/nested_${iteration}_${base%.*}_$$"
                if extract_archive_file "$archive" "$dest"; then
                  rm -f "$archive"
                  found=1
                else
                  rm -rf "$dest"
                fi
              done < <(find "$EXTRACT_DIR" -type f                 \( -name "*.zip" -o -name "*.tar" -o -name "*.tgz" -o -name "*.tar.gz" -o -name "*.tbz" -o -name "*.tar.bz2" -o -name "*.txz" -o -name "*.tar.xz" -o -name "*.tar.zst" -o -name "*.tar.zstd" -o -name "*.zst" -o -name "*.zstd" \) -print0)

              [ $found -eq 0 ] && break
              iteration=$((iteration+1))
            done
          }

          locate_sources_in_dir() {
            local search_root="$1"
            while IFS= read -r headers_path; do
              local parent
              parent="$(dirname "$headers_path")"
              if [ -d "$parent/Util" ]; then
                HEADERS_SRC="$headers_path"
                UTIL_SRC="$parent/Util"
                return 0
              fi
            done < <(find "$search_root" -type d -name "Headers" 2>/dev/null)
            return 1
          }

          copy_sources_to_local() {
            local temp_root="$EXTRACT_DIR/copied_$(date +%s)"
            mkdir -p "$temp_root"
            cp -R "$HEADERS_SRC" "$temp_root/Headers"
            cp -R "$UTIL_SRC" "$temp_root/Util"
            HEADERS_SRC="$temp_root/Headers"
            UTIL_SRC="$temp_root/Util"
          }

          run_extract_scripts() {
            local search_root="$1"
            local scripts=()
            while IFS= read -r script_path; do
              scripts+=("$script_path")
            done < <(find "$search_root" -type f -name "extractzstd.sh" 2>/dev/null)

            if [ "${#scripts[@]}" -eq 0 ]; then
              echo "â„¹ï¸ extractzstd.sh ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (ã‚¹ã‚­ãƒƒãƒ—)"
              return 0
            fi

            for script_path in "${scripts[@]}"; do
              [ -f "$script_path" ] || continue
              echo "ðŸ§° extractã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ: $script_path"
              chmod +x "$script_path" || true
              (cd "$(dirname "$script_path")" && bash "$(basename "$script_path")")
            done
          }

          run_extract_scripts "$EXTRACT_DIR"

          locate_sources_in_dir "$EXTRACT_DIR" || true

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            extract_nested_archives
            locate_sources_in_dir "$EXTRACT_DIR" || true
          fi

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            DMG_FILE=$(find "$EXTRACT_DIR" -type f -name "*.dmg" | head -1)
            if [ -n "$DMG_FILE" ]; then
              echo "ðŸ’¿ DMGã‚’ãƒžã‚¦ãƒ³ãƒˆã—ã¾ã™: $DMG_FILE"
              MOUNT_POINT=$(mktemp -d)
              if hdiutil attach "$DMG_FILE" -mountpoint "$MOUNT_POINT" -quiet; then
                if locate_sources_in_dir "$MOUNT_POINT"; then
                  copy_sources_to_local
                fi
                hdiutil detach "$MOUNT_POINT" -quiet || true
              else
                echo "âš ï¸  DMGã®ãƒžã‚¦ãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: $DMG_FILE"
              fi
            fi
          fi

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            extract_nested_archives
            locate_sources_in_dir "$EXTRACT_DIR" || true
          fi

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            echo "âŒ SDKå†…ã« Headers/Util ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            find "$EXTRACT_DIR" -type d | head -40
            exit 1
          fi
          mkdir -p "$EXPECTED_SDK_PATH"
          rm -rf "$EXPECTED_SDK_PATH/Headers" "$EXPECTED_SDK_PATH/Util"
          cp -R "$HEADERS_SRC" "$EXPECTED_SDK_PATH/Headers"
          cp -R "$UTIL_SRC" "$EXPECTED_SDK_PATH/Util"

          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f AE_SDK.zip
          rm -rf "$EXTRACT_DIR"
          
          # æœ€çµ‚ç¢ºèª
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âœ… AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
            echo "ðŸ“ AeSDKãƒ‘ã‚¹: $EXPECTED_SDK_PATH"
            echo "ðŸ“ Headers: $EXPECTED_SDK_PATH/Headers ($(ls -1 "$EXPECTED_SDK_PATH/Headers" | wc -l | xargs) ãƒ•ã‚¡ã‚¤ãƒ«)"
            echo "ðŸ“ Util: $EXPECTED_SDK_PATH/Util ($(ls -1 "$EXPECTED_SDK_PATH/Util" | wc -l | xargs) ãƒ•ã‚¡ã‚¤ãƒ«)"
          else
            echo "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "æƒ³å®šãƒ‘ã‚¹: $EXPECTED_SDK_PATH"
            echo "å­˜åœ¨ç¢ºèª:"
            [ -d "$EXPECTED_SDK_PATH" ] && echo "  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å­˜åœ¨ã—ã¾ã™" || echo "  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            [ -d "$EXPECTED_SDK_PATH/Headers" ] && echo "  - Headers/ ã¯å­˜åœ¨ã—ã¾ã™" || echo "  - Headers/ ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            [ -d "$EXPECTED_SDK_PATH/Util" ] && echo "  - Util/ ã¯å­˜åœ¨ã—ã¾ã™" || echo "  - Util/ ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo ""
            echo "å±•é–‹ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            ls -la "$(dirname "$EXPECTED_SDK_PATH")" | head -20
            exit 1
          fi

      # 6. Windowsç”¨: GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AE SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          
          $EXPECTED_SDK_PATH = "${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDKãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: $EXPECTED_SDK_PATH"
            exit 0
          }
          
          # GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®å€™è£œï¼ˆå„ªå…ˆé †ä½é †ï¼‰
          $RELEASE_TAG_CANDIDATES = @("sdk", "ae-sdk_25.6_61", "v25.6.61", "25.6.61")
          $REPO = "rebuildup/my-ae-sdk-storage"
          
          Write-Output "ðŸ“¦ GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AeSDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
          Write-Output "   ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
          Write-Output "   SDKãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.sdk_file }}"
          
          # ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª
          if (-not $env:GITHUB_TOKEN) {
            Write-Output "âŒ GITHUB_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            Write-Output "   GitHub Secretsã« AE_SDK_DOWNLOAD_TOKEN ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          }
          
          # ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ã‚¿ã‚°å€™è£œã‚’è©¦ã™ï¼‰
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept = "application/vnd.github.v3+json"
          }
          
          $releaseJson = $null
          $foundTag = $null
          
          foreach ($RELEASE_TAG in $RELEASE_TAG_CANDIDATES) {
            Write-Output "ðŸ” ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­... (ã‚¿ã‚°: $RELEASE_TAG)"
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $RELEASE_TAG
              Write-Output "âœ… ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $foundTag"
              break
            } catch {
              $statusCode = $_.Exception.Response.StatusCode.value__
              Write-Output "âš ï¸  ã‚¿ã‚° '$RELEASE_TAG' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (HTTP $statusCode)"
            }
          }
          
          # ã©ã®ã‚¿ã‚°ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è©¦ã™
          if (-not $releaseJson) {
            Write-Output "âš ï¸  æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—ã—ã¾ã™..."
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/latest"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $releaseJson.tag_name
              Write-Output "âœ… æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $foundTag"
            } catch {
              Write-Output "âŒ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
              Write-Output "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($_.Exception.Response.StatusCode.value__)"
              Write-Output "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $($_.Exception.Message)"
              Write-Output ""
              Write-Output "è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
              Write-Output "  1. ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„"
              Write-Output "  2. ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„ï¼ˆè©¦ã—ãŸã‚¿ã‚°: $($RELEASE_TAG_CANDIDATES -join ', ')ï¼‰"
              Write-Output "  3. GitHub Personal Access Token (PAT) ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹"
              Write-Output "  4. AE_SDK_DOWNLOAD_TOKEN ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„"
              exit 1
            }
          }
          
          # ã‚¢ã‚»ãƒƒãƒˆã®ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          Write-Output "ðŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ:"
          $releaseJson.assets | ForEach-Object { Write-Output "   - $($_.name)" }
          
          # ã‚¢ã‚»ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
          $asset = $releaseJson.assets | Where-Object { $_.name -eq "${{ matrix.sdk_file }}" } | Select-Object -First 1

          if (-not $asset) {
            Write-Output "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ matrix.sdk_file }}"
            Write-Output "åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆã®ä¸€è¦§:"
            $releaseJson.assets | ForEach-Object { Write-Output "   - $($_.name)" }
            exit 1
          }

          $apiDownloadUrl = $asset.url
          $browserDownloadUrl = $asset.browser_download_url

          if (-not $apiDownloadUrl) {
            Write-Output "âŒ APIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒå–å¾—ã§ãã¾ã›ã‚“"
            Write-Output ($asset | ConvertTo-Json -Depth 5)
            exit 1
          }

          Write-Output "ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL(API): $apiDownloadUrl"
          if ($browserDownloadUrl) { Write-Output "ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL(ãƒ–ãƒ©ã‚¦ã‚¶): $browserDownloadUrl" }

          # SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (APIçµŒç”±)
          Write-Output "â¬‡ï¸  SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
          $outputPath = "AE_SDK.zip"
          $downloadHeaders = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept = "application/octet-stream"
            "User-Agent" = "GitHub-Actions"
          }

          try {
            Invoke-WebRequest -Uri $apiDownloadUrl -Headers $downloadHeaders -OutFile $outputPath -ErrorAction Stop
          } catch {
            Write-Output "âš ï¸  APIçµŒç”±ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: $($_.Exception.Message)"
            if ($browserDownloadUrl) {
              Write-Output "è©¦è¡Œ: ãƒ–ãƒ©ã‚¦ã‚¶URLã‚’ä½¿ç”¨ (èªè¨¼ãªã—)"
              try {
                Invoke-WebRequest -Uri $browserDownloadUrl -OutFile $outputPath -ErrorAction Stop
              } catch {
                Write-Output "âŒ SDKã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
                Write-Output "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($_.Exception.Response.StatusCode.value__)"
                Write-Output "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $($_.Exception.Message)"
                exit 1
              }
            } else {
              exit 1
            }
          }
          
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if (-not (Test-Path $outputPath) -or (Get-Item $outputPath).Length -eq 0) {
            Write-Output "âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã§ã™"
            exit 1
          }
          
          $fileSize = (Get-Item $outputPath).Length / 1MB
          Write-Output "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº† ($([math]::Round($fileSize, 2)) MB)"
          
          Write-Output "ðŸ“¦ SDKã‚’å±•é–‹ä¸­..."
          $extractDir = Join-Path $env:RUNNER_TEMP ("ae_sdk_" + [Guid]::NewGuid().ToString())
          New-Item -ItemType Directory -Path $extractDir -Force | Out-Null

          try {
            Expand-Archive -Path $outputPath -DestinationPath $extractDir -Force -ErrorAction Stop
          } catch {
            Write-Output "âŒ SDKã®å±•é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: $($_.Exception.Message)"
            Get-ChildItem $extractDir -Recurse | Select-Object -First 40 | Format-Table FullName, LastWriteTime
            exit 1
          }

          function Get-SevenZipPath {
            $candidates = @(
              "$env:ProgramFiles\7-Zip\7z.exe",
              "$env:ProgramFiles(x86)\7-Zip\7z.exe",
              "C:\Program Files\7-Zip\7z.exe"
            )
            foreach ($candidate in $candidates) {
              if (Test-Path $candidate) { return $candidate }
            }
            return $null
          }

          $SevenZipPath = Get-SevenZipPath

          function Expand-ArchiveSmart {
            param(
              [string]$Archive,
              [string]$Destination
            )

            $lower = $Archive.ToLowerInvariant()

            if ($lower.EndsWith(".zip")) {
              Expand-Archive -LiteralPath $Archive -DestinationPath $Destination -Force
              return $true
            }

            if ($SevenZipPath) {
              & $SevenZipPath x $Archive ("-o" + $Destination) -y | Out-Null
              return $true
            }

            if ($lower.EndsWith(".tar")) {
              & tar -xf $Archive -C $Destination
              return $true
            }

            if ($lower.EndsWith(".tar.gz") -or $lower.EndsWith(".tgz")) {
              & tar -xzf $Archive -C $Destination
              return $true
            }

            if ($lower.EndsWith(".tar.bz2") -or $lower.EndsWith(".tbz") -or $lower.EndsWith(".tbz2")) {
              & tar -xjf $Archive -C $Destination
              return $true
            }

            if ($lower.EndsWith(".tar.xz") -or $lower.EndsWith(".txz")) {
              & tar -xJf $Archive -C $Destination
              return $true
            }

            Write-Output "âš ï¸  æœªå¯¾å¿œã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å½¢å¼ã§ã™: $Archive"
            return $false
          }

          function Expand-NestedArchives {
            param([string]$Root)
            for ($i = 0; $i -lt 6; $i++) {
              $archives = Get-ChildItem -Path $Root -Recurse -File -ErrorAction SilentlyContinue |
                Where-Object { $_.Name -match '\.(zip|tar|tgz|tar\.gz|tbz|tar\.bz2|txz|tar\.xz|tar\.zst|tar\.zstd|zst|zstd)$' }
              if (-not $archives) { break }

              $expanded = $false
              foreach ($archive in $archives) {
                if (-not (Test-Path $archive.FullName)) { continue }
                $dest = Join-Path $archive.Directory.FullName ("nested_{0}_{1}" -f $i, [Guid]::NewGuid().ToString('N'))
                New-Item -ItemType Directory -Force -Path $dest | Out-Null
                if (Expand-ArchiveSmart -Archive $archive.FullName -Destination $dest) {
                  Remove-Item $archive.FullName -Force -ErrorAction SilentlyContinue
                  $expanded = $true
                } else {
                  Remove-Item -Recurse -Force $dest -ErrorAction SilentlyContinue
                }
              }

              if (-not $expanded) { break }
            }
          }

          Expand-NestedArchives -Root $extractDir

          function Get-SdkSourceDirs {
            param([string]$root)
            $headersDirs = Get-ChildItem -Path $root -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -ieq "Headers" }

            foreach ($hdr in $headersDirs) {
              $utilPath = Join-Path $hdr.Parent.FullName "Util"
              if (Test-Path $utilPath) {
                return [pscustomobject]@{
                  Headers = $hdr.FullName
                  Util    = $utilPath
                  Root    = $hdr.Parent.FullName
                }
              }
            }
            return $null
          }

          function Invoke-SdkPrepScripts {
            param([string]$root)
            $scripts = Get-ChildItem -Path $root -Filter "*.bat" -Recurse -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -match '(setup|install|extract|expand|prepare|unpack)' } |
              Sort-Object FullName

            foreach ($script in $scripts) {
              Write-Output ("â–¶ SDKæº–å‚™ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ: {0}" -f $script.FullName)
              & cmd.exe /c "`"$($script.FullName)`""
              if ($LASTEXITCODE -ne 0) {
                Write-Output ("âš ï¸  ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒçµ‚äº†ã‚³ãƒ¼ãƒ‰ {0} ã‚’è¿”ã—ã¾ã—ãŸ" -f $LASTEXITCODE)
              }
              $result = Get-SdkSourceDirs -root $root
              if ($result) { return $result }
            }

            return $null
          }

          function Invoke-BuildAll {
            param([string]$root)
            $solution = Get-ChildItem -Path $root -Recurse -Filter "BuildAll.sln" -ErrorAction SilentlyContinue |
              Select-Object -First 1

            if ($solution) {
              Write-Output ("ðŸ”¨ BuildAll ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™: {0}" -f $solution.FullName)
              & msbuild $solution.FullName `
                /m `
                /p:Configuration=Release `
                /p:Platform=x64 `
                /v:minimal
            } else {
              Write-Output "âš ï¸ BuildAll.sln ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (ã‚¹ã‚­ãƒƒãƒ—)"
            }
          }

          $sources = Get-SdkSourceDirs -root $extractDir
          if (-not $sources) {
            $sources = Invoke-SdkPrepScripts -root $extractDir
          }

          if (-not $sources) {
            Write-Output "âŒ SDKå†…ã« Headers/Util ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            Get-ChildItem $extractDir -Recurse -Directory | Select-Object -First 40 | Format-Table FullName
            exit 1
          }

          $sdkRoot = $sources.Root

          Invoke-BuildAll -root $sdkRoot

          $projectDir = "${{ steps.project_path.outputs.project_dir }}"
          if ($projectDir -and (Test-Path $projectDir)) {
            $sdkTemplateRoot = Join-Path $sdkRoot "Template"
            New-Item -ItemType Directory -Force -Path $sdkTemplateRoot | Out-Null
            $targetTemplate = Join-Path $sdkTemplateRoot (Split-Path $projectDir -Leaf)
            if (Test-Path $targetTemplate) {
              Remove-Item -Recurse -Force $targetTemplate -ErrorAction SilentlyContinue
            }
            Write-Output ("ðŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’SDKã«é…ç½®: {0}" -f $targetTemplate)
            Copy-Item -Recurse -Force $projectDir $targetTemplate
          }

          New-Item -ItemType Directory -Force -Path $EXPECTED_SDK_PATH | Out-Null
          Remove-Item -Recurse -Force (Join-Path $EXPECTED_SDK_PATH "Headers") -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force (Join-Path $EXPECTED_SDK_PATH "Util") -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Force $sources.Headers (Join-Path $EXPECTED_SDK_PATH "Headers")
          Copy-Item -Recurse -Force $sources.Util (Join-Path $EXPECTED_SDK_PATH "Util")

          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            $headerCount = (Get-ChildItem "$EXPECTED_SDK_PATH\Headers" -File | Measure-Object).Count
            $utilCount = (Get-ChildItem "$EXPECTED_SDK_PATH\Util" -File | Measure-Object).Count
            Write-Output "âœ… AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
            Write-Output "ðŸ“ AeSDKãƒ‘ã‚¹: $EXPECTED_SDK_PATH"
            Write-Output "ðŸ“ Headers: $EXPECTED_SDK_PATH\Headers ($headerCount ãƒ•ã‚¡ã‚¤ãƒ«)"
            Write-Output "ðŸ“ Util: $EXPECTED_SDK_PATH\Util ($utilCount ãƒ•ã‚¡ã‚¤ãƒ«)"
          } else {
            Write-Output "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            Write-Output "æƒ³å®šãƒ‘ã‚¹: $EXPECTED_SDK_PATH"
            Write-Output "å­˜åœ¨ç¢ºèª:"
            if (Test-Path "$EXPECTED_SDK_PATH") { Write-Output "  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å­˜åœ¨ã—ã¾ã™" } else { Write-Output "  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“" }
            if (Test-Path "$EXPECTED_SDK_PATH\Headers") { Write-Output "  - Headers\ ã¯å­˜åœ¨ã—ã¾ã™" } else { Write-Output "  - Headers\ ãŒå­˜åœ¨ã—ã¾ã›ã‚“" }
            if (Test-Path "$EXPECTED_SDK_PATH\Util") { Write-Output "  - Util\ ã¯å­˜åœ¨ã—ã¾ã™" } else { Write-Output "  - Util\ ãŒå­˜åœ¨ã—ã¾ã›ã‚“" }
            Write-Output ""
            Write-Output "å±•é–‹ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            $parentDir = Split-Path -Parent $EXPECTED_SDK_PATH
            Get-ChildItem $parentDir | Select-Object -First 20 | Format-Table Name, Length, LastWriteTime
            exit 1
          }

          Remove-Item $outputPath -Force -ErrorAction SilentlyContinue
          Remove-Item $extractDir -Recurse -Force -ErrorAction SilentlyContinue

      # 7. Macç”¨: Xcodeãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
      - name: Build Xcode Project (Unsigned)
        if: matrix.platform == 'mac'
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†
          
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          echo "ðŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $PROJECT_DIR"
          echo "ðŸ“ ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $BUILD_DIR"
          
          cd "$BUILD_DIR"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -f "sep_color.xcodeproj/project.pbxproj" ]; then
            echo "âŒ Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $BUILD_DIR/sep_color.xcodeproj"
            exit 1
          fi
          
          echo "ðŸ”¨ Xcodeãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™..."
          
          # xcodebuildã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼‰
          if ! xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Debug \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee xcodebuild.log; then
            echo "âŒ Xcodeãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo ""
            echo "ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã®æœ€å¾Œã®50è¡Œ:"
            tail -50 xcodebuild.log || true
            echo ""
            echo "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
            grep -i "error" xcodebuild.log | tail -20 || true
            exit 1
          fi
          
          echo "âœ… Xcodeãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
          
          # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®ç¢ºèª
          echo "ðŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’æ¤œç´¢:"
          PLUGIN_PATH=$(find build -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $PLUGIN_PATH"
            echo "ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(du -h "$PLUGIN_PATH" | cut -f1)"
          else
            echo "âš ï¸  ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "æ¤œç´¢ãƒ‘ã‚¹: $BUILD_DIR/build"
            find build -type d -name "*.plugin" 2>/dev/null || true
            echo ""
            echo "ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la build 2>/dev/null || true
            exit 1
          fi

      # 8. Windowsç”¨: MSBuildãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
      - name: Build Visual Studio Project (Unsigned)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          # MSBuildã§ãƒ“ãƒ«ãƒ‰
          msbuild sep_color.sln `
            /p:Configuration=Debug `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Debug\" `
            /t:Build `
            /v:minimal
          
          # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®ç¢ºèª
          Write-Output "ðŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’æ¤œç´¢:"
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            Write-Output "âœ… ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $($AEX_PATH.FullName)"
          } else {
            Write-Output "âš ï¸  ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            Get-ChildItem -Path "$BUILD_DIR\build" -Filter "*.aex" -Recurse -ErrorAction SilentlyContinue
          }

      # 9. Macç”¨: .pluginãƒãƒ³ãƒ‰ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .plugin Bundle
        if: success() && matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-unsigned.zip"
            echo "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ: sep_color-macOS-unsigned.zip"
          fi

      # 10. Windowsç”¨: .aexãƒ•ã‚¡ã‚¤ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .aex File
        if: success() && matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-unsigned.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ: sep_color-Windows-unsigned.zip"
          }

      # 11. ãƒ†ã‚¹ãƒˆç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Test Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-unsigned
          path: |
            Template/sep_color/Mac/sep_color-macOS-unsigned.zip
            Template/sep_color/Win/sep_color-Windows-unsigned.zip
            sep_color/Mac/sep_color-macOS-unsigned.zip
            sep_color/Win/sep_color-Windows-unsigned.zip
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # ============================================
  # ã‚¸ãƒ§ãƒ–2: ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ (ç½²åä»˜ã)
  # ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ - Mac/Windowsä¸¡æ–¹
  # ============================================
  build-release:
    name: Build, Sign, and Package Release
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}
    
    # ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã®ã¿ã€ã“ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†
          
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
            exit 0
          fi
          
          # GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®å€™è£œï¼ˆå„ªå…ˆé †ä½é †ï¼‰
          RELEASE_TAG_CANDIDATES=("sdk" "ae-sdk_25.6_61" "v25.6.61" "25.6.61")
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "ðŸ“¦ GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AeSDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
          echo "   ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
          echo "   SDKãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.sdk_file }}"
          
          # ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ GITHUB_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          
          # ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ã‚¿ã‚°å€™è£œã‚’è©¦ã™ï¼‰
          RELEASE_JSON=""
          HTTP_STATUS=""
          FOUND_TAG=""
          
          for RELEASE_TAG in "${RELEASE_TAG_CANDIDATES[@]}"; do
            echo "ðŸ” ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­... (ã‚¿ã‚°: $RELEASE_TAG)"
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG="$RELEASE_TAG"
              echo "âœ… ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $FOUND_TAG"
              break
            else
              echo "âš ï¸  ã‚¿ã‚° '$RELEASE_TAG' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (HTTP $HTTP_STATUS)"
            fi
          done
          
          # ã©ã®ã‚¿ã‚°ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è©¦ã™
          if [ -z "$FOUND_TAG" ]; then
            echo "âš ï¸  æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—ã—ã¾ã™..."
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/latest" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "âœ… æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $FOUND_TAG"
            fi
          fi
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_STATUS)"
            echo "$RELEASE_JSON" | head -30
            echo ""
            echo "è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
            echo "  1. ãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„"
            echo "  2. ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„ï¼ˆè©¦ã—ãŸã‚¿ã‚°: ${RELEASE_TAG_CANDIDATES[*]}ï¼‰"
            echo "  3. GitHub Personal Access Token (PAT) ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹"
            echo "  4. AE_SDK_DOWNLOAD_TOKEN ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„"
            exit 1
          fi
          
          # ã‚¢ã‚»ãƒƒãƒˆã®æƒ…å ±ã‚’å–å¾—
          ASSET_NAME="${{ matrix.sdk_file }}"
          
          # JSONã‹ã‚‰ã‚¢ã‚»ãƒƒãƒˆæƒ…å ±ã‚’æŠ½å‡ºï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•ï¼‰
          ASSET_INFO=$(echo "$RELEASE_JSON" | grep -A 30 "\"name\":\s*\"$ASSET_NAME\"" | head -30)
          
          if [ -z "$ASSET_INFO" ]; then
            echo "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $ASSET_NAME"
            echo "åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆã®ä¸€è¦§:"
            echo "$RELEASE_JSON" | grep -o '"name":"[^"]*"' | head -10
            exit 1
          fi
          
          # browser_download_urlã‚’å–å¾—
          DOWNLOAD_URL=$(echo "$ASSET_INFO" | grep -o "\"browser_download_url\":\s*\"[^\"]*\"" | head -1 | cut -d'"' -f4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $ASSET_NAME"
            echo "ã‚¢ã‚»ãƒƒãƒˆæƒ…å ±:"
            echo "$ASSET_INFO" | head -20
            exit 1
          fi
          
          echo "ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: $DOWNLOAD_URL"
          
          # SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã‚‹ï¼‰
          echo "â¬‡ï¸  SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
          echo "   ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: $DOWNLOAD_URL"
          echo "   èªè¨¼: $([ -n "$GITHUB_TOKEN" ] && echo "ã‚ã‚Š" || echo "ãªã—")"
          
          # ã¾ãšèªè¨¼ä»˜ãã§è©¦ã™
          CURL_OUTPUT=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -H "User-Agent: GitHub-Actions" \
               -o AE_SDK.zip \
               -s -S "$DOWNLOAD_URL" 2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_STATUS=$(echo "$CURL_OUTPUT" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
          
          # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆHTTP_STATUSè¡Œã‚’é™¤ãï¼‰
          CURL_ERROR=$(echo "$CURL_OUTPUT" | grep -v "HTTP_STATUS:" || echo "")
          
          echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_STATUS"
          echo "ðŸ“Š curlçµ‚äº†ã‚³ãƒ¼ãƒ‰: $CURL_EXIT_CODE"
          
          if [ -n "$CURL_ERROR" ]; then
            echo "ðŸ“Š curlã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
            echo "$CURL_ERROR" | head -10
          fi
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200ã§ãªã„å ´åˆã€ã¾ãŸã¯curlãŒå¤±æ•—ã—ãŸå ´åˆ
          if [ "$HTTP_STATUS" != "200" ] || [ "$CURL_EXIT_CODE" != "0" ]; then
            echo "âš ï¸  èªè¨¼ä»˜ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE)"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
            [ -f "AE_SDK.zip" ] && rm -f AE_SDK.zip
            
            # èªè¨¼ãªã—ã§è©¦ã™ï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆï¼‰
            echo "è©¦è¡Œ: èªè¨¼ãªã—ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã¾ã™..."
            CURL_OUTPUT2=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
                 -H "Accept: application/octet-stream" \
                 -H "User-Agent: GitHub-Actions" \
                 -o AE_SDK.zip \
                 -s -S "$DOWNLOAD_URL" 2>&1)
            
            CURL_EXIT_CODE2=$?
            HTTP_STATUS2=$(echo "$CURL_OUTPUT2" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
            CURL_ERROR2=$(echo "$CURL_OUTPUT2" | grep -v "HTTP_STATUS:" || echo "")
            
            echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (èªè¨¼ãªã—): $HTTP_STATUS2"
            echo "ðŸ“Š curlçµ‚äº†ã‚³ãƒ¼ãƒ‰ (èªè¨¼ãªã—): $CURL_EXIT_CODE2"
            
            if [ -n "$CURL_ERROR2" ]; then
              echo "ðŸ“Š curlã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (èªè¨¼ãªã—):"
              echo "$CURL_ERROR2" | head -10
            fi
            
            if [ "$HTTP_STATUS2" != "200" ] || [ "$CURL_EXIT_CODE2" != "0" ]; then
              echo "âŒ SDKã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo ""
              echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
              echo "  ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: $DOWNLOAD_URL"
              echo "  èªè¨¼ä»˜ã: HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE"
              echo "  èªè¨¼ãªã—: HTTP $HTTP_STATUS2, exit $CURL_EXIT_CODE2"
              echo "  ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š: $([ -n "$GITHUB_TOKEN" ] && echo "ã‚ã‚Š (é•·ã•: ${#GITHUB_TOKEN})" || echo "ãªã—")"
              echo ""
              echo "è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
              echo "  1. GitHub Personal Access Token (PAT) ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹"
              echo "  2. ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„"
              echo "  3. ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ç„¡åŠ¹"
              echo "  4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒç„¡åŠ¹ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„"
              echo "  5. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
              exit 1
            else
              echo "âœ… èªè¨¼ãªã—ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
            fi
          else
            echo "âœ… èªè¨¼ä»˜ãã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
          fi
          
          if [ ! -f "AE_SDK.zip" ] || [ ! -s "AE_SDK.zip" ]; then
            echo "âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã§ã™"
            exit 1
          fi
          
          echo "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº† ($(du -h AE_SDK.zip | cut -f1))"
          
          mkdir -p "$(dirname "$EXPECTED_SDK_PATH")"
          echo "ðŸ“¦ SDKã‚’å±•é–‹ä¸­..."
          unzip -q AE_SDK.zip -d "$(dirname "$EXPECTED_SDK_PATH")" || {
            unzip -q AE_SDK.zip
            [ -d "Adobe-AE-SDK" ] && mv Adobe-AE-SDK "$EXPECTED_SDK_PATH" || \
            [ -d "SDK" ] && mv SDK "$EXPECTED_SDK_PATH" || \
            mkdir -p "$EXPECTED_SDK_PATH" && find . -maxdepth 1 -type d \( -name "Headers" -o -name "Util" \) -exec mv {} "$EXPECTED_SDK_PATH/" \;
          }
          rm -f AE_SDK.zip
          
          if [ ! -d "$EXPECTED_SDK_PATH/Headers" ] || [ ! -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "âœ… AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        shell: powershell
        run: |
          $EXPECTED_SDK_PATH = "${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util")) {
            Write-Output "âœ… AeSDKãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
            exit 0
          }
          
          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®å€™è£œï¼ˆå„ªå…ˆé †ä½é †ï¼‰
          $RELEASE_TAG_CANDIDATES = @("sdk", "ae-sdk_25.6_61", "v25.6.61", "25.6.61")
          $REPO = "rebuildup/my-ae-sdk-storage"
          
          Write-Output "ðŸ“¦ GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰AeSDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
          Write-Output "   ãƒªãƒã‚¸ãƒˆãƒª: $REPO"
          Write-Output "   SDKãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.sdk_file }}"
          
          # ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª
          if (-not $env:GITHUB_TOKEN) {
            Write-Output "âŒ GITHUB_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          }
          
          # ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ã‚¿ã‚°å€™è£œã‚’è©¦ã™ï¼‰
          $headers = @{
            Authorization = "token $env:GITHUB_TOKEN"
            Accept = "application/vnd.github.v3+json"
          }
          
          $releaseJson = $null
          $foundTag = $null
          
          foreach ($RELEASE_TAG in $RELEASE_TAG_CANDIDATES) {
            Write-Output "ðŸ” ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­... (ã‚¿ã‚°: $RELEASE_TAG)"
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $RELEASE_TAG
              Write-Output "âœ… ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $foundTag"
              break
            } catch {
              $statusCode = $_.Exception.Response.StatusCode.value__
              Write-Output "âš ï¸  ã‚¿ã‚° '$RELEASE_TAG' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (HTTP $statusCode)"
            }
          }
          
          # ã©ã®ã‚¿ã‚°ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è©¦ã™
          if (-not $releaseJson) {
            Write-Output "âš ï¸  æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—ã—ã¾ã™..."
            $releaseUrl = "https://api.github.com/repos/$REPO/releases/latest"
            
            try {
              $releaseJson = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -ErrorAction Stop
              $foundTag = $releaseJson.tag_name
              Write-Output "âœ… æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ: $foundTag"
            } catch {
              Write-Output "âŒ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
              Write-Output "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($_.Exception.Response.StatusCode.value__)"
              Write-Output "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $($_.Exception.Message)"
              exit 1
            }
          }
          
          # ã‚¢ã‚»ãƒƒãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆèªè¨¼ãŒå¿…è¦ãªå ´åˆã¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼‰
          $assetName = "${{ matrix.sdk_file }}"
          $asset = $releaseJson.assets | Where-Object { $_.name -eq $assetName }
          
          if (-not $asset) {
            Write-Output "âŒ SDKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $assetName"
            Write-Output "åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚»ãƒƒãƒˆ:"
            $releaseJson.assets | ForEach-Object { Write-Output "   - $($_.name)" }
            exit 1
          }
          
          # èªè¨¼ãŒå¿…è¦ãªå ´åˆã¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã€ãã†ã§ãªã„å ´åˆã¯browser_download_urlã‚’ä½¿ç”¨
          if ($asset.url) {
            $downloadUrl = $asset.url
            Write-Output "ðŸ“¥ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨: $downloadUrl"
          } else {
            $downloadUrl = $asset.browser_download_url
            Write-Output "ðŸ“¥ ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’ä½¿ç”¨: $downloadUrl"
          }
          
          Write-Output "â¬‡ï¸  SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
          
          try {
            Invoke-WebRequest -Uri $downloadUrl -Headers $headers -OutFile "AE_SDK.zip" -ErrorAction Stop
            Write-Output "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
          } catch {
            $statusCode = $_.Exception.Response.StatusCode.value__
            $errorMessage = $_.Exception.Message
            Write-Output "âŒ SDKã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            Write-Output "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $statusCode"
            Write-Output "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $errorMessage"
            Write-Output ""
            Write-Output "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            Write-Output "  ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL: $downloadUrl"
            Write-Output "  ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š: $(if ($env:GITHUB_TOKEN) { 'ã‚ã‚Š' } else { 'ãªã—' })"
            Write-Output ""
            Write-Output "è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
            Write-Output "  1. GitHub Personal Access Token (PAT) ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹"
            Write-Output "  2. ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„"
            Write-Output "  3. ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ç„¡åŠ¹"
            exit 1
          }
          
          if (-not (Test-Path "AE_SDK.zip") -or (Get-Item "AE_SDK.zip").Length -eq 0) {
            Write-Output "âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã§ã™"
            exit 1
          }
          
          $fileSize = (Get-Item "AE_SDK.zip").Length / 1MB
          Write-Output "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº† ($([math]::Round($fileSize, 2)) MB)"
          
          $parentDir = Split-Path -Parent $EXPECTED_SDK_PATH
          New-Item -ItemType Directory -Force -Path $parentDir | Out-Null
          Expand-Archive -Path "AE_SDK.zip" -DestinationPath $parentDir -Force
          
          if (Test-Path "$parentDir\Adobe-AE-SDK") {
            Move-Item "$parentDir\Adobe-AE-SDK" $EXPECTED_SDK_PATH -Force
          } elseif (Test-Path "$parentDir\SDK") {
            Move-Item "$parentDir\SDK" $EXPECTED_SDK_PATH -Force
          } elseif ((Test-Path "$parentDir\Headers") -or (Test-Path "$parentDir\Util")) {
            New-Item -ItemType Directory -Force -Path $EXPECTED_SDK_PATH | Out-Null
            if (Test-Path "$parentDir\Headers") { Move-Item "$parentDir\Headers" $EXPECTED_SDK_PATH -Force }
            if (Test-Path "$parentDir\Util") { Move-Item "$parentDir\Util" $EXPECTED_SDK_PATH -Force }
          }
          
          Remove-Item "AE_SDK.zip" -Force
          
          if (-not ((Test-Path "$EXPECTED_SDK_PATH\Headers") -and (Test-Path "$EXPECTED_SDK_PATH\Util"))) {
            Write-Output "âŒ AeSDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }

      # Macç”¨: ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‹ãƒ³ã‚°ç”¨ï¼‰
      - name: Install Apple Certificate and Profile
        if: matrix.platform == 'mac'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/
          mkdir -p "$PROFILE_PATH"
          PROVISIONING_PROFILE_PATH=$RUNNER_TEMP/profile.provisionprofile
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PROVISIONING_PROFILE_PATH
          cp $PROVISIONING_PROFILE_PATH "$PROFILE_PATH"

      # Macç”¨: Xcodeãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ (ç½²åã‚ã‚Š)
      - name: Build Xcode Project (Signed)
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR"
          
          xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Release \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build"

      # Windowsç”¨: MSBuildãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ (Release)
      - name: Build Visual Studio Project (Release)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          msbuild sep_color.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Release\" `
            /t:Build `
            /v:minimal

      # Macç”¨: .pluginãƒãƒ³ãƒ‰ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .plugin Bundle
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-${{ github.ref_name }}.zip"
            echo "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ"
          fi

      # Windowsç”¨: .aexãƒ•ã‚¡ã‚¤ãƒ«ã®ZIPåœ§ç¸®
      - name: Compress .aex File
        if: matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-${{ github.ref_name }}.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã¾ã—ãŸ"
          }

      # ãƒªãƒªãƒ¼ã‚¹ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Release Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-${{ github.ref_name }}
          path: |
            Template/sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            Template/sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
            sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
          retention-days: 90
          if-no-files-found: warn
          compression-level: 6
