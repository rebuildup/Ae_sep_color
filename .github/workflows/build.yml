name: Build After Effects Plugin

on:
  pull_request:
    branches: [ main, master, develop ]
  
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  
  workflow_dispatch:

jobs:
  # ============================================
  # „Ç∏„Éß„Éñ1: „Éì„É´„Éâ„Å®„ÉÜ„Çπ„Éà (ÁΩ≤Âêç„Å™„Åó)
  # „Éó„É´„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÊ§úË®ºÁî® - Mac/Windows‰∏°Êñπ
  # ============================================
  build-test:
    name: Build and Test (Unsigned)
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}

    steps:
      # 1. „Ç≥„Éº„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. MacÁî®: Xcode„Éê„Éº„Ç∏„Éß„É≥„ÅÆË®≠ÂÆö
      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # 3. MacÁî®: Xcode„É©„Ç§„Çª„É≥„Çπ„ÅÆÂêåÊÑè
      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      # 4. WindowsÁî®: Visual Studio „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      # 5. MacÁî®: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éë„Çπ„ÅÆÁ¢∫Ë™ç
      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      # 5. WindowsÁî®: „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éë„Çπ„ÅÆÁ¢∫Ë™ç
      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # 5.5. „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éë„Çπ„ÇíÁµ±Âêà
      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 6. MacÁî®: GitHub„É™„É™„Éº„Çπ„Åã„ÇâAE SDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          set -e  # „Ç®„É©„ÉºÊôÇ„Å´Âç≥Â∫ß„Å´ÁµÇ‰∫Ü
          
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          # AeSDK„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "‚úÖ AeSDK„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô: $EXPECTED_SDK_PATH"
            exit 0
          fi
          
          # GitHub API„Çí‰ΩøÁî®„Åó„Å¶„É™„É™„Éº„ÇπÊÉÖÂ†±„ÇíÂèñÂæó
          # „É™„É™„Éº„Çπ„Çø„Ç∞„ÅÆÂÄôË£úÔºàÂÑ™ÂÖàÈ†Ü‰ΩçÈ†ÜÔºâ
          RELEASE_TAG_CANDIDATES=("sdk" "ae-sdk_25.6_61" "v25.6.61" "25.6.61")
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "üì¶ GitHub„É™„É™„Éº„Çπ„Åã„ÇâAeSDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô"
          echo "   „É™„Éù„Ç∏„Éà„É™: $REPO"
          echo "   SDK„Éï„Ç°„Ç§„É´: ${{ matrix.sdk_file }}"
          
          # „Éà„Éº„ÇØ„É≥„ÅÆÁ¢∫Ë™ç
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå GITHUB_TOKEN„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
            echo "   GitHub Secrets„Å´ AE_SDK_DOWNLOAD_TOKEN „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
            exit 1
          fi
          
          # „É™„É™„Éº„ÇπÊÉÖÂ†±„ÇíÂèñÂæóÔºàË§áÊï∞„ÅÆ„Çø„Ç∞ÂÄôË£ú„ÇíË©¶„ÅôÔºâ
          RELEASE_JSON=""
          HTTP_STATUS=""
          FOUND_TAG=""
          
          for RELEASE_TAG in "${RELEASE_TAG_CANDIDATES[@]}"; do
            echo "üîç „É™„É™„Éº„ÇπÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠... („Çø„Ç∞: $RELEASE_TAG)"
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "üìä HTTP„Çπ„ÉÜ„Éº„Çø„Çπ: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG="$RELEASE_TAG"
              echo "‚úÖ „É™„É™„Éº„Çπ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü: $FOUND_TAG"
              break
            else
              echo "‚ö†Ô∏è  „Çø„Ç∞ '$RELEASE_TAG' „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü (HTTP $HTTP_STATUS)"
            fi
          done
          
          # „Å©„ÅÆ„Çø„Ç∞„ÇÇË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄÊñ∞„É™„É™„Éº„Çπ„ÇíË©¶„Åô
          if [ -z "$FOUND_TAG" ]; then
            echo "‚ö†Ô∏è  ÊåáÂÆö„Åï„Çå„Åü„Çø„Ç∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÊñ∞„É™„É™„Éº„Çπ„ÇíÂèñÂæó„Åó„Åæ„Åô..."
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/latest" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "‚úÖ ÊúÄÊñ∞„É™„É™„Éº„Çπ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü: $FOUND_TAG"
            fi
          fi
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå „É™„É™„Éº„ÇπÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP $HTTP_STATUS)"
            echo "„É¨„Çπ„Éù„É≥„Çπ:"
            echo "$RELEASE_JSON" | head -30
            echo ""
            echo "ËÄÉ„Åà„Çâ„Çå„ÇãÂéüÂõ†:"
            echo "  1. „É™„Éù„Ç∏„Éà„É™„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ„Éó„É©„Ç§„Éô„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Åß„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„Å™„ÅÑ"
            echo "  2. „É™„É™„Éº„Çπ„Çø„Ç∞„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÔºàË©¶„Åó„Åü„Çø„Ç∞: ${RELEASE_TAG_CANDIDATES[*]}Ôºâ"
            echo "  3. GitHub Personal Access Token (PAT) „ÅÆÊ®©Èôê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã"
            echo "  4. AE_SDK_DOWNLOAD_TOKEN „ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ"
            echo ""
            echo "„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:"
            echo "  „É™„Éù„Ç∏„Éà„É™: $REPO"
            echo "  Ë©¶„Åó„Åü„Çø„Ç∞: ${RELEASE_TAG_CANDIDATES[*]}"
            exit 1
          fi
          
          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | grep -q '"message":"Not Found"'; then
            echo "‚ùå „É™„É™„Éº„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
            echo "„É¨„Çπ„Éù„É≥„Çπ:"
            echo "$RELEASE_JSON" | head -30
            exit 1
          fi
          
          # „Ç¢„Çª„ÉÉ„Éà„ÅÆ‰∏ÄË¶ß„ÇíË°®Á§∫Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
          echo "üìã Âà©Áî®ÂèØËÉΩ„Å™„Ç¢„Çª„ÉÉ„Éà:"
          echo "$RELEASE_JSON" | jq -r '.assets[]?.name' | head -10 | while read name; do
            [ -n "$name" ] && echo "   - $name"
          done

          # „Ç¢„Çª„ÉÉ„Éà„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó
          ASSET_NAME="${{ matrix.sdk_file }}"
          ASSET_JSON=$(echo "$RELEASE_JSON" | jq -c --arg name "$ASSET_NAME" '.assets[]? | select(.name == $name)' | head -1)

          if [ -z "$ASSET_JSON" ]; then
            echo "‚ùå SDK„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: $ASSET_NAME"
            echo "Âà©Áî®ÂèØËÉΩ„Å™„Ç¢„Çª„ÉÉ„Éà„ÅÆ‰∏ÄË¶ß:"
            echo "$RELEASE_JSON" | jq -r '.assets[]?.name' | head -10
            exit 1
          fi

          API_DOWNLOAD_URL=$(echo "$ASSET_JSON" | jq -r '.url // empty')
          BROWSER_DOWNLOAD_URL=$(echo "$ASSET_JSON" | jq -r '.browser_download_url // empty')

          if [ -z "$API_DOWNLOAD_URL" ]; then
            echo "‚ùå API„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì"
            echo "$ASSET_JSON"
            exit 1
          fi

          echo "üì• „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL(API): $API_DOWNLOAD_URL"
          [ -n "$BROWSER_DOWNLOAD_URL" ] && echo "üì• „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL(„Éñ„É©„Ç¶„Ç∂): $BROWSER_DOWNLOAD_URL"
          
          # SDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàË™çË®º„Éò„ÉÉ„ÉÄ„Éº„Çí‰ªò„Åë„ÇãÔºâ
          echo "‚¨áÔ∏è  SDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠..."
          echo "   „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: ${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}"
          echo "   Ë™çË®º: $([ -n "$GITHUB_TOKEN" ] && echo "„ÅÇ„Çä" || echo "„Å™„Åó")"
          
          # „Åæ„ÅöË™çË®º‰ªò„Åç„ÅßË©¶„Åô
          CURL_OUTPUT=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -H "User-Agent: GitHub-Actions" \
               -o AE_SDK.zip \
               -s -S "$API_DOWNLOAD_URL" 2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_STATUS=$(echo "$CURL_OUTPUT" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
          
          # „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæóÔºàHTTP_STATUSË°å„ÇíÈô§„ÅèÔºâ
          CURL_ERROR=$(echo "$CURL_OUTPUT" | grep -v "HTTP_STATUS:" || echo "")
          
          echo "üìä HTTP„Çπ„ÉÜ„Éº„Çø„Çπ: $HTTP_STATUS"
          echo "üìä curlÁµÇ‰∫Ü„Ç≥„Éº„Éâ: $CURL_EXIT_CODE"
          
          if [ -n "$CURL_ERROR" ]; then
            echo "üìä curl„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:"
            echo "$CURL_ERROR" | head -10
          fi
          
          # HTTP„Çπ„ÉÜ„Éº„Çø„Çπ„Åå200„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØcurl„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà
          if [ "$HTTP_STATUS" != "200" ] || [ "$CURL_EXIT_CODE" != "0" ]; then
            echo "‚ö†Ô∏è  Ë™çË®º‰ªò„Åç„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE)"
            
            # „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂâäÈô§
            [ -f "AE_SDK.zip" ] && rm -f AE_SDK.zip
            
            # Ë™çË®º„Å™„Åó„ÅßË©¶„ÅôÔºà„Éë„Éñ„É™„ÉÉ„ÇØ„É™„Éù„Ç∏„Éà„É™„ÅÆÂ†¥ÂêàÔºâ
            echo "Ë©¶Ë°å: Ë™çË®º„Å™„Åó„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíË©¶„Åø„Åæ„Åô..."
            CURL_OUTPUT2=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
                 -H "Accept: application/octet-stream" \
                 -H "User-Agent: GitHub-Actions" \
                 -o AE_SDK.zip \
                 -s -S "${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}" 2>&1)
            
            CURL_EXIT_CODE2=$?
            HTTP_STATUS2=$(echo "$CURL_OUTPUT2" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
            CURL_ERROR2=$(echo "$CURL_OUTPUT2" | grep -v "HTTP_STATUS:" || echo "")
            
            echo "üìä HTTP„Çπ„ÉÜ„Éº„Çø„Çπ (Ë™çË®º„Å™„Åó): $HTTP_STATUS2"
            echo "üìä curlÁµÇ‰∫Ü„Ç≥„Éº„Éâ (Ë™çË®º„Å™„Åó): $CURL_EXIT_CODE2"
            
            if [ -n "$CURL_ERROR2" ]; then
              echo "üìä curl„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ (Ë™çË®º„Å™„Åó):"
              echo "$CURL_ERROR2" | head -10
            fi
            
            if [ "$HTTP_STATUS2" != "200" ] || [ "$CURL_EXIT_CODE2" != "0" ]; then
              echo "‚ùå SDK„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
              echo ""
              echo "„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:"
              echo "  „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: ${BROWSER_DOWNLOAD_URL:-$API_DOWNLOAD_URL}"
              echo "  Ë™çË®º‰ªò„Åç: HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE"
              echo "  Ë™çË®º„Å™„Åó: HTTP $HTTP_STATUS2, exit $CURL_EXIT_CODE2"
              echo "  „Éà„Éº„ÇØ„É≥Ë®≠ÂÆö: $([ -n "$GITHUB_TOKEN" ] && echo "„ÅÇ„Çä (Èï∑„Åï: ${#GITHUB_TOKEN})" || echo "„Å™„Åó")"
              echo ""
              echo "ËÄÉ„Åà„Çâ„Çå„ÇãÂéüÂõ†:"
              echo "  1. GitHub Personal Access Token (PAT) „ÅÆÊ®©Èôê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã"
              echo "  2. „Éó„É©„Ç§„Éô„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„Å™„ÅÑ"
              echo "  3. „Éà„Éº„ÇØ„É≥„ÅåÊúüÈôêÂàá„Çå„Åæ„Åü„ÅØÁÑ°Âäπ"
              echo "  4. „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL„ÅåÁÑ°Âäπ„Åæ„Åü„ÅØ„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Å™„ÅÑ"
              echo "  5. „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åæ„Åü„ÅØ„Çø„Ç§„É†„Ç¢„Ç¶„Éà"
              exit 1
            else
              echo "‚úÖ Ë™çË®º„Å™„Åó„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊàêÂäü"
            fi
          else
            echo "‚úÖ Ë™çË®º‰ªò„Åç„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊàêÂäü"
          fi
          
          # „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åü„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          if [ ! -f "AE_SDK.zip" ] || [ ! -s "AE_SDK.zip" ]; then
            echo "‚ùå „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åü„Éï„Ç°„Ç§„É´„ÅåÁÑ°Âäπ„Åß„Åô"
            exit 1
          fi
          
          echo "‚úÖ „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫Ü ($(du -h AE_SDK.zip | cut -f1))"
          
          # SDK„ÇíÂ±ïÈñãÔºà„ÉÜ„É≥„Éù„É©„É™„Éá„Ç£„É¨„ÇØ„Éà„É™„Å∏Ôºâ
          echo "üì¶ SDK„ÇíÂ±ïÈñã‰∏≠..."
          EXTRACT_DIR=$(mktemp -d)
          if ! unzip -q AE_SDK.zip -d "$EXTRACT_DIR"; then
            echo "‚ùå SDK„ÅÆÂ±ïÈñã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            ls -la "$EXTRACT_DIR" || true
            exit 1
          fi

          HEADERS_SRC=""
          UTIL_SRC=""

          extract_archive_file() {
            local archive="$1"
            local destination="$2"
            local lower
            lower=$(printf '%s' "$archive" | tr '[:upper:]' '[:lower:]')

            mkdir -p "$destination"

            if [[ "$lower" == *.tar.zst || "$lower" == *.tar.zstd ]]; then
              if tar --help 2>&1 | grep -q -- "--zstd"; then
                tar --zstd -xf "$archive" -C "$destination"
              elif command -v zstd >/dev/null 2>&1; then
                local tmp_tar="$destination/$(basename "${archive%.*}").tar"
                zstd -d "$archive" -o "$tmp_tar"
                tar -xf "$tmp_tar" -C "$destination"
                rm -f "$tmp_tar"
              else
                echo "‚ö†Ô∏è  zstd„Ç≥„Éû„É≥„Éâ„ÅåÁÑ°„ÅÑ„Åü„ÇÅÂ±ïÈñã„Åß„Åç„Åæ„Åõ„Çì: $archive"
                return 1
              fi
            elif [[ "$lower" == *.tar.gz || "$lower" == *.tgz ]]; then
              tar -xzf "$archive" -C "$destination"
            elif [[ "$lower" == *.tar.bz2 || "$lower" == *.tbz || "$lower" == *.tbz2 ]]; then
              tar -xjf "$archive" -C "$destination"
            elif [[ "$lower" == *.tar.xz || "$lower" == *.txz ]]; then
              tar -xJf "$archive" -C "$destination"
            elif [[ "$lower" == *.tar ]]; then
              tar -xf "$archive" -C "$destination"
            elif [[ "$lower" == *.zst || "$lower" == *.zstd ]]; then
              if command -v zstd >/dev/null 2>&1; then
                local output="$destination/$(basename "${archive%.*}")"
                zstd -d "$archive" -o "$output"
              else
                echo "‚ö†Ô∏è  zstd„Ç≥„Éû„É≥„Éâ„ÅåÁÑ°„ÅÑ„Åü„ÇÅÂ±ïÈñã„Åß„Åç„Åæ„Åõ„Çì: $archive"
                return 1
              fi
            elif [[ "$lower" == *.gz ]]; then
              gunzip -c "$archive" > "$destination/$(basename "${archive%.*}")"
            elif [[ "$lower" == *.bz2 ]]; then
              bunzip2 -c "$archive" > "$destination/$(basename "${archive%.*}")"
            elif [[ "$lower" == *.xz ]]; then
              unxz -c "$archive" > "$destination/$(basename "${archive%.*}")"
            elif [[ "$lower" == *.zip ]]; then
              unzip -q "$archive" -d "$destination"
            else
              return 1
            fi

            return 0
          }

          extract_nested_archives() {
            local iteration=0
            while [ $iteration -lt 6 ]; do
              local found=0
              while IFS= read -r -d '' archive; do
                [ -f "$archive" ] || continue
                local base
                base=$(basename "$archive")
                local dest="$EXTRACT_DIR/nested_${iteration}_${base%.*}_$$"
                if extract_archive_file "$archive" "$dest"; then
                  rm -f "$archive"
                  found=1
                else
                  rm -rf "$dest"
                fi
              done < <(find "$EXTRACT_DIR" -type f                 \( -name "*.zip" -o -name "*.tar" -o -name "*.tgz" -o -name "*.tar.gz" -o -name "*.tbz" -o -name "*.tar.bz2" -o -name "*.txz" -o -name "*.tar.xz" -o -name "*.tar.zst" -o -name "*.tar.zstd" -o -name "*.zst" -o -name "*.zstd" \) -print0)

              [ $found -eq 0 ] && break
              iteration=$((iteration+1))
            done
          }

          locate_sources_in_dir() {
            local search_root="$1"
            while IFS= read -r headers_path; do
              local parent
              parent="$(dirname "$headers_path")"
              if [ -d "$parent/Util" ]; then
                HEADERS_SRC="$headers_path"
                UTIL_SRC="$parent/Util"
                return 0
              fi
            done < <(find "$search_root" -type d -name "Headers" 2>/dev/null)
            return 1
          }

          copy_sources_to_local() {
            local temp_root="$EXTRACT_DIR/copied_$(date +%s)"
            mkdir -p "$temp_root"
            cp -R "$HEADERS_SRC" "$temp_root/Headers"
            cp -R "$UTIL_SRC" "$temp_root/Util"
            HEADERS_SRC="$temp_root/Headers"
            UTIL_SRC="$temp_root/Util"
          }

          run_extract_scripts() {
            local search_root="$1"
            local scripts=()
            while IFS= read -r script_path; do
              scripts+=("$script_path")
            done < <(find "$search_root" -type f -name "extractzstd.sh" 2>/dev/null)

            if [ "${#scripts[@]}" -eq 0 ]; then
              echo "‚ÑπÔ∏è extractzstd.sh „ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü („Çπ„Ç≠„ÉÉ„Éó)"
              return 0
            fi

            for script_path in "${scripts[@]}"; do
              [ -f "$script_path" ] || continue
              echo "üß∞ extract„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å: $script_path"
              chmod +x "$script_path" || true
              (cd "$(dirname "$script_path")" && bash "$(basename "$script_path")")
            done
          }

          run_extract_scripts "$EXTRACT_DIR"

          locate_sources_in_dir "$EXTRACT_DIR" || true

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            extract_nested_archives
            locate_sources_in_dir "$EXTRACT_DIR" || true
          fi

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            DMG_FILE=$(find "$EXTRACT_DIR" -type f -name "*.dmg" | head -1)
            if [ -n "$DMG_FILE" ]; then
              echo "üíø DMG„Çí„Éû„Ç¶„É≥„Éà„Åó„Åæ„Åô: $DMG_FILE"
              MOUNT_POINT=$(mktemp -d)
              if hdiutil attach "$DMG_FILE" -mountpoint "$MOUNT_POINT" -quiet; then
                if locate_sources_in_dir "$MOUNT_POINT"; then
                  copy_sources_to_local
                fi
                hdiutil detach "$MOUNT_POINT" -quiet || true
              else
                echo "‚ö†Ô∏è  DMG„ÅÆ„Éû„Ç¶„É≥„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: $DMG_FILE"
              fi
            fi
          fi

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            extract_nested_archives
            locate_sources_in_dir "$EXTRACT_DIR" || true
          fi

          if [ -z "$HEADERS_SRC" ] || [ -z "$UTIL_SRC" ]; then
            echo "‚ùå SDKÂÜÖ„Å´ Headers/Util „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
            find "$EXTRACT_DIR" -type d | head -40
            exit 1
          fi
          mkdir -p "$EXPECTED_SDK_PATH"
          rm -rf "$EXPECTED_SDK_PATH/Headers" "$EXPECTED_SDK_PATH/Util"
          cp -R "$HEADERS_SRC" "$EXPECTED_SDK_PATH/Headers"
          cp -R "$UTIL_SRC" "$EXPECTED_SDK_PATH/Util"

          # „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
          rm -f AE_SDK.zip
          rm -rf "$EXTRACT_DIR"
          
          # ÊúÄÁµÇÁ¢∫Ë™ç
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "‚úÖ AeSDK„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"
            echo "üìÅ AeSDK„Éë„Çπ: $EXPECTED_SDK_PATH"
            echo "üìÅ Headers: $EXPECTED_SDK_PATH/Headers ($(ls -1 "$EXPECTED_SDK_PATH/Headers" | wc -l | xargs) „Éï„Ç°„Ç§„É´)"
            echo "üìÅ Util: $EXPECTED_SDK_PATH/Util ($(ls -1 "$EXPECTED_SDK_PATH/Util" | wc -l | xargs) „Éï„Ç°„Ç§„É´)"
          else
            echo "‚ùå AeSDK„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo "ÊÉ≥ÂÆö„Éë„Çπ: $EXPECTED_SDK_PATH"
            echo "Â≠òÂú®Á¢∫Ë™ç:"
            [ -d "$EXPECTED_SDK_PATH" ] && echo "  - „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅØÂ≠òÂú®„Åó„Åæ„Åô" || echo "  - „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì"
            [ -d "$EXPECTED_SDK_PATH/Headers" ] && echo "  - Headers/ „ÅØÂ≠òÂú®„Åó„Åæ„Åô" || echo "  - Headers/ „ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì"
            [ -d "$EXPECTED_SDK_PATH/Util" ] && echo "  - Util/ „ÅØÂ≠òÂú®„Åó„Åæ„Åô" || echo "  - Util/ „ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì"
            echo ""
            echo "Â±ïÈñã„Åï„Çå„Åü„Éï„Ç°„Ç§„É´:"
            ls -la "$(dirname "$EXPECTED_SDK_PATH")" | head -20
            exit 1
          fi

      # 6. WindowsÁî®: GitHub„É™„É™„Éº„Çπ„Åã„ÇâAE SDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        shell: pwsh
        env:
          AE_SDK_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          $script = Join-Path "${{ github.workspace }}" ".github\\scripts\\setup-ae-sdk-windows.ps1"
          $params = @{
            ExpectedSdkPath = "${{ steps.project_path.outputs.expected_sdk_path }}"
            ProjectDir      = "${{ steps.project_path.outputs.project_dir }}"
            SdkAsset        = "${{ matrix.sdk_file }}"
            Repo            = "rebuildup/my-ae-sdk-storage"
            ReleaseTags     = @('sdk','ae-sdk_25.6_61','v25.6.61','25.6.61')
          }
          if ($env:AE_SDK_TOKEN) {
            $params['Token'] = $env:AE_SDK_TOKEN
          }
          & $script @params
      - name: Build Xcode Project (Unsigned)
        if: matrix.platform == 'mac'
        run: |
          set -e  # „Ç®„É©„ÉºÊôÇ„Å´Âç≥Â∫ß„Å´ÁµÇ‰∫Ü
          
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          echo "üìÅ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™: $PROJECT_DIR"
          echo "üìÅ „Éì„É´„Éâ„Éá„Ç£„É¨„ÇØ„Éà„É™: $BUILD_DIR"
          
          cd "$BUILD_DIR"
          
          # „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          if [ ! -f "sep_color.xcodeproj/project.pbxproj" ]; then
            echo "‚ùå Xcode„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: $BUILD_DIR/sep_color.xcodeproj"
            exit 1
          fi
          
          echo "üî® Xcode„Éì„É´„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åô..."
          
          # xcodebuild„ÇíÂÆüË°åÔºà„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫Ôºâ
          if ! xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Debug \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee xcodebuild.log; then
            echo "‚ùå Xcode„Éì„É´„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo ""
            echo "„Éì„É´„Éâ„É≠„Ç∞„ÅÆÊúÄÂæå„ÅÆ50Ë°å:"
            tail -50 xcodebuild.log || true
            echo ""
            echo "„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:"
            grep -i "error" xcodebuild.log | tail -20 || true
            exit 1
          fi
          
          echo "‚úÖ Xcode„Éì„É´„Éâ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"
          
          # „Éì„É´„ÉâÊàêÊûúÁâ©„ÅÆÁ¢∫Ë™ç
          echo "üì¶ „Éì„É´„ÉâÊàêÊûúÁâ©„ÇíÊ§úÁ¥¢:"
          PLUGIN_PATH=$(find build -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            echo "‚úÖ „Éì„É´„ÉâÊàêÊûúÁâ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü: $PLUGIN_PATH"
            echo "üìä „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: $(du -h "$PLUGIN_PATH" | cut -f1)"
          else
            echo "‚ö†Ô∏è  „Éì„É´„ÉâÊàêÊûúÁâ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü"
            echo "Ê§úÁ¥¢„Éë„Çπ: $BUILD_DIR/build"
            find build -type d -name "*.plugin" 2>/dev/null || true
            echo ""
            echo "„Éì„É´„Éâ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÜÖÂÆπ:"
            ls -la build 2>/dev/null || true
            exit 1
          fi

      # 8. WindowsÁî®: MSBuild„Éì„É´„Éâ„ÅÆÂÆüË°å
      - name: Build Visual Studio Project (Unsigned)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          # MSBuild„Åß„Éì„É´„Éâ
          msbuild sep_color.sln `
            /p:Configuration=Debug `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Debug\" `
            /t:Build `
            /v:minimal
          
          # „Éì„É´„ÉâÊàêÊûúÁâ©„ÅÆÁ¢∫Ë™ç
          Write-Output "üì¶ „Éì„É´„ÉâÊàêÊûúÁâ©„ÇíÊ§úÁ¥¢:"
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            Write-Output "‚úÖ „Éì„É´„ÉâÊàêÊûúÁâ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü: $($AEX_PATH.FullName)"
          } else {
            Write-Output "‚ö†Ô∏è  „Éì„É´„ÉâÊàêÊûúÁâ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü"
            Get-ChildItem -Path "$BUILD_DIR\build" -Filter "*.aex" -Recurse -ErrorAction SilentlyContinue
          }

      # 9. MacÁî®: .plugin„Éê„É≥„Éâ„É´„ÅÆZIPÂúßÁ∏Æ
      - name: Compress .plugin Bundle
        if: success() && matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-unsigned.zip"
            echo "‚úÖ „Éó„É©„Ç∞„Ç§„É≥„Éê„É≥„Éâ„É´„ÇíÂúßÁ∏Æ„Åó„Åæ„Åó„Åü: sep_color-macOS-unsigned.zip"
          fi

      # 10. WindowsÁî®: .aex„Éï„Ç°„Ç§„É´„ÅÆZIPÂúßÁ∏Æ
      - name: Compress .aex File
        if: success() && matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-unsigned.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "‚úÖ „Éó„É©„Ç∞„Ç§„É≥„Éï„Ç°„Ç§„É´„ÇíÂúßÁ∏Æ„Åó„Åæ„Åó„Åü: sep_color-Windows-unsigned.zip"
          }

      # 11. „ÉÜ„Çπ„ÉàÁî®„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      - name: Upload Test Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-unsigned
          path: |
            Template/sep_color/Mac/sep_color-macOS-unsigned.zip
            Template/sep_color/Win/sep_color-Windows-unsigned.zip
            sep_color/Mac/sep_color-macOS-unsigned.zip
            sep_color/Win/sep_color-Windows-unsigned.zip
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # ============================================
  # „Ç∏„Éß„Éñ2: „É™„É™„Éº„Çπ„Éì„É´„Éâ (ÁΩ≤Âêç‰ªò„Åç)
  # „Çø„Ç∞„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„ÅüÊôÇ„ÅÆ„ÅøÂÆüË°å - Mac/Windows‰∏°Êñπ
  # ============================================
  build-release:
    name: Build, Sign, and Package Release
    strategy:
      matrix:
        os: [macos-14, windows-latest]
        include:
          - os: macos-14
            sdk_file: AfterEffectsSDK_25.6_61_mac.zip
            platform: mac
          - os: windows-latest
            sdk_file: AfterEffectsSDK_25.6_61_win.zip
            platform: win
    
    runs-on: ${{ matrix.os }}
    
    # „Çø„Ç∞„Åå„Éó„ÉÉ„Ç∑„É•„Åï„Çå„ÅüÊôÇ„ÅÆ„Åø„ÄÅ„Åì„ÅÆ„Ç∏„Éß„Éñ„ÇíÂÆüË°å
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Xcode
        if: matrix.platform == 'mac'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Accept Xcode license
        if: matrix.platform == 'mac'
        run: sudo xcodebuild -license accept

      - name: Set up MSBuild
        if: matrix.platform == 'win'
        uses: microsoft/setup-msbuild@v2

      - name: Determine project path (Mac)
        if: matrix.platform == 'mac'
        id: project_path_mac
        run: |
          REPO_ROOT="$(pwd)"
          PROJECT_DIR="$REPO_ROOT"
          
          if [ -d "Template/sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/Template/sep_color"
          elif [ -d "sep_color" ]; then
            PROJECT_DIR="$REPO_ROOT/sep_color"
          fi
          
          BUILD_DIR="$PROJECT_DIR/Mac"
          EXPECTED_SDK_PATH="$(cd "$BUILD_DIR" && cd ../../.. && pwd)"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "expected_sdk_path=$EXPECTED_SDK_PATH" >> $GITHUB_OUTPUT

      - name: Determine project path (Windows)
        if: matrix.platform == 'win'
        id: project_path_win
        shell: powershell
        run: |
          $REPO_ROOT = Get-Location
          $PROJECT_DIR = $REPO_ROOT
          
          if (Test-Path "Template\sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "Template\sep_color"
          } elseif (Test-Path "sep_color") {
            $PROJECT_DIR = Join-Path $REPO_ROOT "sep_color"
          }
          
          $BUILD_DIR = Join-Path $PROJECT_DIR "Win"
          $EXPECTED_SDK_PATH = (Get-Item (Join-Path $BUILD_DIR "..\..\..")).FullName
          
          Write-Output "project_dir=$PROJECT_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "build_dir=$BUILD_DIR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Output "expected_sdk_path=$EXPECTED_SDK_PATH" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Set project path outputs
        id: project_path
        run: |
          if [ "${{ matrix.platform }}" == "mac" ]; then
            echo "project_dir=${{ steps.project_path_mac.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_mac.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_mac.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_dir=${{ steps.project_path_win.outputs.project_dir }}" >> $GITHUB_OUTPUT
            echo "build_dir=${{ steps.project_path_win.outputs.build_dir }}" >> $GITHUB_OUTPUT
            echo "expected_sdk_path=${{ steps.project_path_win.outputs.expected_sdk_path }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Download AE SDK from GitHub Release (Mac)
        if: matrix.platform == 'mac'
        env:
          GITHUB_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          set -e  # „Ç®„É©„ÉºÊôÇ„Å´Âç≥Â∫ß„Å´ÁµÇ‰∫Ü
          
          EXPECTED_SDK_PATH="${{ steps.project_path.outputs.expected_sdk_path }}"
          
          if [ -d "$EXPECTED_SDK_PATH/Headers" ] && [ -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "‚úÖ AeSDK„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô"
            exit 0
          fi
          
          # GitHub API„Çí‰ΩøÁî®„Åó„Å¶„É™„É™„Éº„ÇπÊÉÖÂ†±„ÇíÂèñÂæó
          # „É™„É™„Éº„Çπ„Çø„Ç∞„ÅÆÂÄôË£úÔºàÂÑ™ÂÖàÈ†Ü‰ΩçÈ†ÜÔºâ
          RELEASE_TAG_CANDIDATES=("sdk" "ae-sdk_25.6_61" "v25.6.61" "25.6.61")
          REPO="rebuildup/my-ae-sdk-storage"
          
          echo "üì¶ GitHub„É™„É™„Éº„Çπ„Åã„ÇâAeSDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô"
          echo "   „É™„Éù„Ç∏„Éà„É™: $REPO"
          echo "   SDK„Éï„Ç°„Ç§„É´: ${{ matrix.sdk_file }}"
          
          # „Éà„Éº„ÇØ„É≥„ÅÆÁ¢∫Ë™ç
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå GITHUB_TOKEN„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
            exit 1
          fi
          
          # „É™„É™„Éº„ÇπÊÉÖÂ†±„ÇíÂèñÂæóÔºàË§áÊï∞„ÅÆ„Çø„Ç∞ÂÄôË£ú„ÇíË©¶„ÅôÔºâ
          RELEASE_JSON=""
          HTTP_STATUS=""
          FOUND_TAG=""
          
          for RELEASE_TAG in "${RELEASE_TAG_CANDIDATES[@]}"; do
            echo "üîç „É™„É™„Éº„ÇπÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠... („Çø„Ç∞: $RELEASE_TAG)"
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "üìä HTTP„Çπ„ÉÜ„Éº„Çø„Çπ: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG="$RELEASE_TAG"
              echo "‚úÖ „É™„É™„Éº„Çπ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü: $FOUND_TAG"
              break
            else
              echo "‚ö†Ô∏è  „Çø„Ç∞ '$RELEASE_TAG' „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü (HTTP $HTTP_STATUS)"
            fi
          done
          
          # „Å©„ÅÆ„Çø„Ç∞„ÇÇË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄÊñ∞„É™„É™„Éº„Çπ„ÇíË©¶„Åô
          if [ -z "$FOUND_TAG" ]; then
            echo "‚ö†Ô∏è  ÊåáÂÆö„Åï„Çå„Åü„Çø„Ç∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÊñ∞„É™„É™„Éº„Çπ„ÇíÂèñÂæó„Åó„Åæ„Åô..."
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/releases/latest" 2>&1)
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RELEASE_JSON=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" == "200" ]; then
              FOUND_TAG=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "‚úÖ ÊúÄÊñ∞„É™„É™„Éº„Çπ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü: $FOUND_TAG"
            fi
          fi
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå „É™„É™„Éº„ÇπÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP $HTTP_STATUS)"
            echo "$RELEASE_JSON" | head -30
            echo ""
            echo "ËÄÉ„Åà„Çâ„Çå„ÇãÂéüÂõ†:"
            echo "  1. „É™„Éù„Ç∏„Éà„É™„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ„Éó„É©„Ç§„Éô„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Åß„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„Å™„ÅÑ"
            echo "  2. „É™„É™„Éº„Çπ„Çø„Ç∞„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÔºàË©¶„Åó„Åü„Çø„Ç∞: ${RELEASE_TAG_CANDIDATES[*]}Ôºâ"
            echo "  3. GitHub Personal Access Token (PAT) „ÅÆÊ®©Èôê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã"
            echo "  4. AE_SDK_DOWNLOAD_TOKEN „ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ"
            exit 1
          fi
          
          # „Ç¢„Çª„ÉÉ„Éà„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó
          ASSET_NAME="${{ matrix.sdk_file }}"
          
          # JSON„Åã„Çâ„Ç¢„Çª„ÉÉ„ÉàÊÉÖÂ†±„ÇíÊäΩÂá∫Ôºà„Çà„ÇäÁ¢∫ÂÆü„Å™ÊñπÊ≥ïÔºâ
          ASSET_INFO=$(echo "$RELEASE_JSON" | grep -A 30 "\"name\":\s*\"$ASSET_NAME\"" | head -30)
          
          if [ -z "$ASSET_INFO" ]; then
            echo "‚ùå SDK„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: $ASSET_NAME"
            echo "Âà©Áî®ÂèØËÉΩ„Å™„Ç¢„Çª„ÉÉ„Éà„ÅÆ‰∏ÄË¶ß:"
            echo "$RELEASE_JSON" | grep -o '"name":"[^"]*"' | head -10
            exit 1
          fi
          
          # browser_download_url„ÇíÂèñÂæó
          DOWNLOAD_URL=$(echo "$ASSET_INFO" | grep -o "\"browser_download_url\":\s*\"[^\"]*\"" | head -1 | cut -d'"' -f4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "‚ùå „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: $ASSET_NAME"
            echo "„Ç¢„Çª„ÉÉ„ÉàÊÉÖÂ†±:"
            echo "$ASSET_INFO" | head -20
            exit 1
          fi
          
          echo "üì• „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: $DOWNLOAD_URL"
          
          # SDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàË™çË®º„Éò„ÉÉ„ÉÄ„Éº„Çí‰ªò„Åë„ÇãÔºâ
          echo "‚¨áÔ∏è  SDK„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠..."
          echo "   „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: $DOWNLOAD_URL"
          echo "   Ë™çË®º: $([ -n "$GITHUB_TOKEN" ] && echo "„ÅÇ„Çä" || echo "„Å™„Åó")"
          
          # „Åæ„ÅöË™çË®º‰ªò„Åç„ÅßË©¶„Åô
          CURL_OUTPUT=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/octet-stream" \
               -H "User-Agent: GitHub-Actions" \
               -o AE_SDK.zip \
               -s -S "$DOWNLOAD_URL" 2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_STATUS=$(echo "$CURL_OUTPUT" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
          
          # „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæóÔºàHTTP_STATUSË°å„ÇíÈô§„ÅèÔºâ
          CURL_ERROR=$(echo "$CURL_OUTPUT" | grep -v "HTTP_STATUS:" || echo "")
          
          echo "üìä HTTP„Çπ„ÉÜ„Éº„Çø„Çπ: $HTTP_STATUS"
          echo "üìä curlÁµÇ‰∫Ü„Ç≥„Éº„Éâ: $CURL_EXIT_CODE"
          
          if [ -n "$CURL_ERROR" ]; then
            echo "üìä curl„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:"
            echo "$CURL_ERROR" | head -10
          fi
          
          # HTTP„Çπ„ÉÜ„Éº„Çø„Çπ„Åå200„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØcurl„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà
          if [ "$HTTP_STATUS" != "200" ] || [ "$CURL_EXIT_CODE" != "0" ]; then
            echo "‚ö†Ô∏è  Ë™çË®º‰ªò„Åç„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE)"
            
            # „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂâäÈô§
            [ -f "AE_SDK.zip" ] && rm -f AE_SDK.zip
            
            # Ë™çË®º„Å™„Åó„ÅßË©¶„ÅôÔºà„Éë„Éñ„É™„ÉÉ„ÇØ„É™„Éù„Ç∏„Éà„É™„ÅÆÂ†¥ÂêàÔºâ
            echo "Ë©¶Ë°å: Ë™çË®º„Å™„Åó„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíË©¶„Åø„Åæ„Åô..."
            CURL_OUTPUT2=$(curl -L -w "\nHTTP_STATUS:%{http_code}" \
                 -H "Accept: application/octet-stream" \
                 -H "User-Agent: GitHub-Actions" \
                 -o AE_SDK.zip \
                 -s -S "$DOWNLOAD_URL" 2>&1)
            
            CURL_EXIT_CODE2=$?
            HTTP_STATUS2=$(echo "$CURL_OUTPUT2" | grep "HTTP_STATUS:" | cut -d: -f2 || echo "unknown")
            CURL_ERROR2=$(echo "$CURL_OUTPUT2" | grep -v "HTTP_STATUS:" || echo "")
            
            echo "üìä HTTP„Çπ„ÉÜ„Éº„Çø„Çπ (Ë™çË®º„Å™„Åó): $HTTP_STATUS2"
            echo "üìä curlÁµÇ‰∫Ü„Ç≥„Éº„Éâ (Ë™çË®º„Å™„Åó): $CURL_EXIT_CODE2"
            
            if [ -n "$CURL_ERROR2" ]; then
              echo "üìä curl„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ (Ë™çË®º„Å™„Åó):"
              echo "$CURL_ERROR2" | head -10
            fi
            
            if [ "$HTTP_STATUS2" != "200" ] || [ "$CURL_EXIT_CODE2" != "0" ]; then
              echo "‚ùå SDK„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
              echo ""
              echo "„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:"
              echo "  „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: $DOWNLOAD_URL"
              echo "  Ë™çË®º‰ªò„Åç: HTTP $HTTP_STATUS, exit $CURL_EXIT_CODE"
              echo "  Ë™çË®º„Å™„Åó: HTTP $HTTP_STATUS2, exit $CURL_EXIT_CODE2"
              echo "  „Éà„Éº„ÇØ„É≥Ë®≠ÂÆö: $([ -n "$GITHUB_TOKEN" ] && echo "„ÅÇ„Çä (Èï∑„Åï: ${#GITHUB_TOKEN})" || echo "„Å™„Åó")"
              echo ""
              echo "ËÄÉ„Åà„Çâ„Çå„ÇãÂéüÂõ†:"
              echo "  1. GitHub Personal Access Token (PAT) „ÅÆÊ®©Èôê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã"
              echo "  2. „Éó„É©„Ç§„Éô„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„Å™„ÅÑ"
              echo "  3. „Éà„Éº„ÇØ„É≥„ÅåÊúüÈôêÂàá„Çå„Åæ„Åü„ÅØÁÑ°Âäπ"
              echo "  4. „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL„ÅåÁÑ°Âäπ„Åæ„Åü„ÅØ„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Å™„ÅÑ"
              echo "  5. „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åæ„Åü„ÅØ„Çø„Ç§„É†„Ç¢„Ç¶„Éà"
              exit 1
            else
              echo "‚úÖ Ë™çË®º„Å™„Åó„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊàêÂäü"
            fi
          else
            echo "‚úÖ Ë™çË®º‰ªò„Åç„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊàêÂäü"
          fi
          
          if [ ! -f "AE_SDK.zip" ] || [ ! -s "AE_SDK.zip" ]; then
            echo "‚ùå „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åü„Éï„Ç°„Ç§„É´„ÅåÁÑ°Âäπ„Åß„Åô"
            exit 1
          fi
          
          echo "‚úÖ „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫Ü ($(du -h AE_SDK.zip | cut -f1))"
          
          mkdir -p "$(dirname "$EXPECTED_SDK_PATH")"
          echo "üì¶ SDK„ÇíÂ±ïÈñã‰∏≠..."
          unzip -q AE_SDK.zip -d "$(dirname "$EXPECTED_SDK_PATH")" || {
            unzip -q AE_SDK.zip
            [ -d "Adobe-AE-SDK" ] && mv Adobe-AE-SDK "$EXPECTED_SDK_PATH" || \
            [ -d "SDK" ] && mv SDK "$EXPECTED_SDK_PATH" || \
            mkdir -p "$EXPECTED_SDK_PATH" && find . -maxdepth 1 -type d \( -name "Headers" -o -name "Util" \) -exec mv {} "$EXPECTED_SDK_PATH/" \;
          }
          rm -f AE_SDK.zip
          
          if [ ! -d "$EXPECTED_SDK_PATH/Headers" ] || [ ! -d "$EXPECTED_SDK_PATH/Util" ]; then
            echo "‚ùå AeSDK„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            exit 1
          fi
          
          echo "‚úÖ AeSDK„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"

      - name: Download AE SDK from GitHub Release (Windows)
        if: matrix.platform == 'win'
        shell: pwsh
        env:
          AE_SDK_TOKEN: ${{ secrets.AE_SDK_DOWNLOAD_TOKEN }}
        run: |
          $script = Join-Path "${{ github.workspace }}" ".github\\scripts\\setup-ae-sdk-windows.ps1"
          $params = @{
            ExpectedSdkPath = "${{ steps.project_path.outputs.expected_sdk_path }}"
            ProjectDir      = "${{ steps.project_path.outputs.project_dir }}"
            SdkAsset        = "${{ matrix.sdk_file }}"
            Repo            = "rebuildup/my-ae-sdk-storage"
            ReleaseTags     = @('sdk','ae-sdk_25.6_61','v25.6.61','25.6.61')
          }
          if ($env:AE_SDK_TOKEN) {
            $params['Token'] = $env:AE_SDK_TOKEN
          }
          & $script @params
      - name: Build Xcode Project (Signed)
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR"
          
          xcodebuild build \
            -project sep_color.xcodeproj \
            -target sep_color \
            -configuration Release \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            -destination 'platform=macOS' \
            CONFIGURATION_BUILD_DIR="$(pwd)/build"

      # WindowsÁî®: MSBuild„Éì„É´„Éâ„ÅÆÂÆüË°å (Release)
      - name: Build Visual Studio Project (Release)
        if: matrix.platform == 'win'
        run: |
          $PROJECT_DIR = "${{ steps.project_path.outputs.project_dir }}"
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          Set-Location $BUILD_DIR
          
          msbuild sep_color.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:OutDir="$BUILD_DIR\build\x64\Release\" `
            /t:Build `
            /v:minimal

      # MacÁî®: .plugin„Éê„É≥„Éâ„É´„ÅÆZIPÂúßÁ∏Æ
      - name: Compress .plugin Bundle
        if: matrix.platform == 'mac'
        run: |
          PROJECT_DIR="${{ steps.project_path.outputs.project_dir }}"
          BUILD_DIR="${{ steps.project_path.outputs.build_dir }}"
          
          cd "$BUILD_DIR/build"
          
          PLUGIN_PATH=$(find . -name "sep_color.plugin" -type d 2>/dev/null | head -1)
          if [ -n "$PLUGIN_PATH" ]; then
            ditto -c -k --sequesterRsrc "$PLUGIN_PATH" "../sep_color-macOS-${{ github.ref_name }}.zip"
            echo "‚úÖ „Éó„É©„Ç∞„Ç§„É≥„Éê„É≥„Éâ„É´„ÇíÂúßÁ∏Æ„Åó„Åæ„Åó„Åü"
          fi

      # WindowsÁî®: .aex„Éï„Ç°„Ç§„É´„ÅÆZIPÂúßÁ∏Æ
      - name: Compress .aex File
        if: matrix.platform == 'win'
        run: |
          $BUILD_DIR = "${{ steps.project_path.outputs.build_dir }}"
          
          $AEX_PATH = Get-ChildItem -Path "$BUILD_DIR\build" -Filter "sep_color.aex" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($AEX_PATH) {
            $ZIP_PATH = Join-Path $BUILD_DIR "sep_color-Windows-${{ github.ref_name }}.zip"
            Compress-Archive -Path $AEX_PATH.FullName -DestinationPath $ZIP_PATH -Force
            Write-Output "‚úÖ „Éó„É©„Ç∞„Ç§„É≥„Éï„Ç°„Ç§„É´„ÇíÂúßÁ∏Æ„Åó„Åæ„Åó„Åü"
          }

      # „É™„É™„Éº„ÇπÁî®„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      - name: Upload Release Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sep_color-plugin-${{ matrix.platform }}-${{ github.ref_name }}
          path: |
            Template/sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            Template/sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
            sep_color/Mac/sep_color-macOS-${{ github.ref_name }}.zip
            sep_color/Win/sep_color-Windows-${{ github.ref_name }}.zip
          retention-days: 90
          if-no-files-found: warn
          compression-level: 6
